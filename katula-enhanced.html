<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EazzyCalculator - Tables de Katula Enrichies</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 2000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            color: #2c3e50;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3);
        }

        .universes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin: 20px 0;
        }

        .universe-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
        }

        .universe-container.mundo { border-color: #3498db; }
        .universe-container.fruity { border-color: #e74c3c; }
        .universe-container.trigga { border-color: #f39c12; }
        .universe-container.roaster { border-color: #9b59b6; }
        .universe-container.sunshine { border-color: #f1c40f; }

        .universe-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            font-size: 1.3em;
        }

        .universe-header.mundo { background: linear-gradient(135deg, #3498db, #2980b9); }
        .universe-header.fruity { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .universe-header.trigga { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .universe-header.roaster { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .universe-header.sunshine { background: linear-gradient(135deg, #f1c40f, #f39c12); }

        .katula-matrix {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            margin: 15px 0;
            background: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
        }

        .chip-cell {
            display: flex;
            flex-direction: column;
            background: white;
            border: 2px solid #34495e;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 100px;
            overflow: hidden;
        }

        .chip-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .chip-header {
            background: #34495e;
            color: white;
            text-align: center;
            padding: 6px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .chip-drawers {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chip-drawer {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #bdc3c7;
            font-weight: bold;
            transition: all 0.2s ease;
            position: relative;
            font-size: 0.8em;
            padding: 2px;
        }

        .chip-drawer:last-child {
            border-bottom: none;
        }

        .chip-drawer:hover {
            background: rgba(52, 152, 219, 0.3);
            transform: scaleY(1.2);
        }

        .chip-drawer.active {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .chip-drawer.hot {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .chip-drawer.medium {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .chip-drawer.low {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .chip-drawer.inactive {
            background: #ecf0f1;
            color: #7f8c8d;
        }

        .drawer-frequency {
            position: absolute;
            top: 1px;
            right: 1px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6em;
        }

        .universe-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border-left: 3px solid #3498db;
        }

        .stat-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.8em;
            color: #7f8c8d;
        }

        .formes-legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .formes-legend h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            text-align: center;
        }

        .formes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }

        .forme-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9em;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .forme-item:hover {
            border-color: #3498db;
            background: #e8f4ff;
        }

        .forme-item.selected {
            border-color: #27ae60;
            background: #e8fff8;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .universes-grid {
                grid-template-columns: 1fr;
            }

            .katula-matrix {
                gap: 3px;
                padding: 10px;
            }

            .chip-cell {
                min-height: 80px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Tables de Katula Enrichies</h1>
            <p>Visualisation avec vraies formes et tiroirs par chip</p>
        </div>

        <div class="controls">
            <button onclick="loadEnhancedTables()" id="loadBtn">üåç Charger Tables Enrichies</button>
            <button onclick="analyzeFormePatterns()" id="analyzeBtn">üé® Analyser Patterns Formes</button>
            <button onclick="showStatistics()" id="statsBtn">üìä Statistiques Globales</button>
        </div>

        <div id="universesContainer" class="universes-grid"></div>

        <div id="loadingIndicator" class="loading" style="display: none;">
            üîÑ Chargement des Tables de Katula enrichies...
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8006/api/analytics';
        const UNIVERSES = ['mundo', 'fruity', 'trigga', 'roaster', 'sunshine'];
        let universesData = {};
        let selectedForme = null;

        document.addEventListener('DOMContentLoaded', function () {
            loadEnhancedTables();
        });

        async function loadEnhancedTables() {
            const loadBtn = document.getElementById('loadBtn');
            loadBtn.disabled = true;
            loadBtn.textContent = 'üîÑ Chargement...';

            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('universesContainer').innerHTML = '';

            try {
                // Charger les donn√©es enrichies pour chaque univers
                for (const universe of UNIVERSES) {
                    await loadEnhancedUniverseData(universe);
                }

                displayEnhancedUniverses();
                showSuccess('Tables de Katula enrichies charg√©es avec succ√®s!');

            } catch (error) {
                showError('Erreur lors du chargement: ' + error.message);
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'üåç Charger Tables Enrichies';
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        async function loadEnhancedUniverseData(universe) {
            try {
                console.log(`Chargement enrichi de ${universe}...`);

                // Charger la table enrichie
                const tableResponse = await fetch(`${API_BASE}/katula/enhanced/${universe}`);
                if (!tableResponse.ok) {
                    throw new Error(`Erreur table enrichie ${universe}: ${tableResponse.status}`);
                }
                const tableData = await tableResponse.json();

                // Charger les formes r√©elles
                const formesResponse = await fetch(`${API_BASE}/katula/formes/${universe}`);
                const formesData = await formesResponse.json();

                universesData[universe] = {
                    table: tableData,
                    formes: formesData.formes || [],
                    stats: tableData.universe_stats || {}
                };

                console.log(`${universe} enrichi charg√©:`, universesData[universe]);

            } catch (error) {
                console.error(`Erreur chargement enrichi ${universe}:`, error);
                universesData[universe] = {
                    error: error.message
                };
            }
        }

        function displayEnhancedUniverses() {
            const container = document.getElementById('universesContainer');
            let html = '';

            UNIVERSES.forEach(universe => {
                const data = universesData[universe];

                if (data && !data.error) {
                    html += createEnhancedUniverseHTML(universe, data);
                } else {
                    html += createErrorUniverseHTML(universe, data?.error || 'Erreur inconnue');
                }
            });

            container.innerHTML = html;
        }

        function createEnhancedUniverseHTML(universe, data) {
            const universeTitle = universe.charAt(0).toUpperCase() + universe.slice(1);

            let html = `
                <div class="universe-container ${universe}">
                    <div class="universe-header ${universe}">
                        üåç ${universeTitle} (${data.formes.length} formes)
                    </div>
            `;

            // Matrice enrichie avec tiroirs
            if (data.table && data.table.matrix) {
                html += '<div class="katula-matrix">';

                data.table.matrix.forEach(row => {
                    row.forEach(cell => {
                        const chipNumber = cell.chip_number;
                        const enhancedChip = data.table.enhanced_chips[`chip${chipNumber}`];

                        html += `
                            <div class="chip-cell" 
                                 onclick="showEnhancedChipDetails('${cell.chip_id}', '${universe}')"
                                 title="Chip ${chipNumber} - ${enhancedChip?.total_appearances || 0} apparitions">
                                <div class="chip-header">C${chipNumber}</div>
                                <div class="chip-drawers">
                        `;

                        // Cr√©er un tiroir pour chaque forme de l'univers
                        data.formes.forEach(forme => {
                            const frequency = enhancedChip?.formes_frequency?.[forme] || 0;
                            const drawerClass = getDrawerActivityClass(frequency);

                            html += `
                                <div class="chip-drawer ${drawerClass}" 
                                     onclick="event.stopPropagation(); selectDrawer('${cell.chip_id}', '${forme}', '${universe}')"
                                     title="${forme}: ${frequency} fois">
                                    ${forme.substring(0, 4)}
                                    ${frequency > 0 ? `<div class="drawer-frequency">${frequency}</div>` : ''}
                                </div>
                            `;
                        });

                        html += `
                                </div>
                            </div>
                        `;
                    });
                });

                html += '</div>';
            }

            // Statistiques enrichies
            html += createEnhancedStats(universe, data);

            // L√©gende des formes avec fr√©quences
            html += createEnhancedFormesLegend(universe, data);

            html += '</div>';

            return html;
        }

        function createErrorUniverseHTML(universe, error) {
            const universeTitle = universe.charAt(0).toUpperCase() + universe.slice(1);

            return `
                <div class="universe-container ${universe}">
                    <div class="universe-header ${universe}">
                        üåç ${universeTitle}
                    </div>
                    <div class="error">
                        Erreur: ${error}
                    </div>
                </div>
            `;
        }

        function createEnhancedStats(universe, data) {
            const stats = data.stats || {};

            return `
                <div class="universe-stats">
                    <div class="stat-item">
                        <div class="stat-value">${stats.total_combinations || 0}</div>
                        <div class="stat-label">Total Combinaisons</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.active_chips || 0}</div>
                        <div class="stat-label">Chips Actifs</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.formes.length}</div>
                        <div class="stat-label">Formes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.most_popular_forme || 'N/A'}</div>
                        <div class="stat-label">Forme Populaire</div>
                    </div>
                </div>
            `;
        }

        function createEnhancedFormesLegend(universe, data) {
            const stats = data.stats || {};
            const formesDistribution = stats.formes_distribution || {};

            let html = `
                <div class="formes-legend">
                    <h4>üé® Formes de ${universe}</h4>
                    <div class="formes-grid">
            `;

            data.formes.forEach(forme => {
                const frequency = formesDistribution[forme] || 0;
                html += `
                    <div class="forme-item" onclick="selectForme('${forme}', '${universe}')">
                        <strong>${forme}</strong><br>
                        <small>${frequency} fois</small>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        function getDrawerActivityClass(frequency) {
            if (frequency === 0) return 'inactive';
            if (frequency <= 2) return 'low';
            if (frequency <= 5) return 'medium';
            if (frequency <= 10) return 'hot';
            return 'active';
        }

        function selectDrawer(chipId, forme, universe) {
            console.log(`Tiroir s√©lectionn√©: ${chipId} - ${forme} dans ${universe}`);
            
            // Analyser cette forme sp√©cifique
            analyzeSpecificForme(universe, forme);
        }

        async function analyzeSpecificForme(universe, forme) {
            try {
                const response = await fetch(`${API_BASE}/katula/forme-patterns/${universe}/${forme}`);
                const data = await response.json();

                if (response.ok) {
                    showFormeAnalysis(data);
                } else {
                    showError('Erreur analyse forme: ' + data.detail);
                }
            } catch (error) {
                showError('Erreur: ' + error.message);
            }
        }

        function showFormeAnalysis(data) {
            const message = `
üé® ANALYSE FORME: ${data.forme.toUpperCase()}
üåç Univers: ${data.universe}

üìä Statistiques:
- Total apparitions: ${data.total_appearances}
- Chips actifs: ${data.active_chips}
- Chip le plus actif: ${data.most_active_chip || 'N/A'}

üéØ Top 3 Chips:
${data.chip_patterns.slice(0, 3).map((p, i) => 
    `${i+1}. Chip ${p.chip_id}: ${p.frequency} fois`
).join('\n')}
            `;

            alert(message);
        }

        async function showEnhancedChipDetails(chipId, universe) {
            const chipNumber = parseInt(chipId.replace('chip', ''));
            
            try {
                const response = await fetch(`${API_BASE}/katula/chip/${universe}/${chipNumber}`);
                const data = await response.json();

                if (response.ok) {
                    showChipAnalysis(data);
                } else {
                    showError('Erreur d√©tails chip: ' + data.detail);
                }
            } catch (error) {
                showError('Erreur: ' + error.message);
            }
        }

        function showChipAnalysis(data) {
            const formesFreq = Object.entries(data.formes_frequency || {})
                .map(([forme, freq]) => `${forme}: ${freq}`)
                .join('\n');

            const recentCombos = data.combinations.slice(0, 5)
                .map(c => `${c.numbers} (${c.forme})`)
                .join('\n');

            const message = `
üéØ CHIP ${data.chip_number} - ${data.universe.toUpperCase()}

üìä Statistiques:
- Total combinaisons: ${data.total_combinations}
- Forme la plus fr√©quente: ${data.most_frequent_forme || 'N/A'}

üé® R√©partition par forme:
${formesFreq}

üî¢ Derni√®res combinaisons:
${recentCombos}
            `;

            alert(message);
        }

        function selectForme(forme, universe) {
            selectedForme = forme;
            analyzeSpecificForme(universe, forme);
        }

        async function analyzeFormePatterns() {
            if (!selectedForme) {
                showError('S√©lectionnez d\'abord une forme en cliquant dessus');
                return;
            }

            // Analyser cette forme pour tous les univers
            for (const universe of UNIVERSES) {
                await analyzeSpecificForme(universe, selectedForme);
            }
        }

        function showStatistics() {
            let globalStats = '';
            
            UNIVERSES.forEach(universe => {
                const data = universesData[universe];
                if (data && !data.error) {
                    const stats = data.stats || {};
                    globalStats += `
${universe.toUpperCase()}:
- Combinaisons: ${stats.total_combinations || 0}
- Chips actifs: ${stats.active_chips || 0}
- Formes: ${data.formes.length}
- Forme populaire: ${stats.most_popular_forme || 'N/A'}

`;
                }
            });

            alert('üìä STATISTIQUES GLOBALES:\n\n' + globalStats);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.getElementById('universesContainer'));

            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.container').insertBefore(successDiv, document.getElementById('universesContainer'));

            setTimeout(() => successDiv.remove(), 3000);
        }
    </script>
</body>

</html>