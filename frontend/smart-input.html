<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EazzyCalculator - Saisie Intelligente</title>
    <script src="assets/js/universal-header.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1890ff, #40a9ff);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .main-content {
            padding: 30px;
        }
        .session-selector {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #1890ff;
        }
        .session-controls {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: end;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        select, input, button {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.1);
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #40a9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .create-session-btn {
            background: #52c41a;
        }
        .create-session-btn:hover {
            background: #73d13d;
        }
        .progress-section {
            background: linear-gradient(135deg, #f0f9ff, #e6f7ff);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #91d5ff;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1890ff, #52c41a);
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        .draw-input-section {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .draw-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .draw-title {
            font-size: 1.8em;
            color: #1890ff;
            margin: 0;
            font-weight: 600;
        }
        .draw-subtitle {
            color: #666;
            margin: 5px 0 0 0;
        }
        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto 30px auto;
        }
        .number-input {
            position: relative;
        }
        .number-input input {
            width: 100%;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #1890ff;
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px 10px;
            transition: all 0.3s ease;
        }
        .number-input input:focus {
            background: white;
            border-color: #1890ff;
            box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.1);
            transform: scale(1.05);
        }
        .number-input input.filled {
            background: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
        }
        .number-input input.error {
            background: #fff2f0;
            border-color: #ff4d4f;
            color: #ff4d4f;
        }
        .number-input label {
            position: absolute;
            top: -10px;
            left: 10px;
            background: white;
            padding: 0 5px;
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        .save-btn {
            background: #52c41a;
            padding: 15px 30px;
            font-size: 16px;
        }
        .save-btn:hover {
            background: #73d13d;
        }
        .next-btn {
            background: #722ed1;
            padding: 15px 30px;
            font-size: 16px;
        }
        .next-btn:hover {
            background: #9254de;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }
        .modal-form {
            display: grid;
            gap: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close:hover {
            color: #000;
        }
        .success-message {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        .error-message {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #1890ff;
            margin: 0;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0 0 0;
        }
        @media (max-width: 768px) {
            .session-controls {
                grid-template-columns: 1fr;
            }
            .numbers-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="custom-background">
    <div id="header-container"></div>
    <div class="container">
    <script>
    // Injecter le header universel au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof UniversalHeader !== 'undefined') {
            UniversalHeader.injectHeader('header-container', 'smart-input', {
                showNavigation: true,
                showUserInfo: false
            });
        }
    });
    </script>

        <div class="main-content">
            <!-- S√©lecteur de Session -->
            <div class="session-selector">
                <h3 style="margin-top: 0; color: #1890ff;">üìã Gestion des Sessions</h3>
                <div class="session-controls">
                    <div class="form-group">
                        <label for="sessionSelect">Session Active:</label>
                        <select id="sessionSelect">
                            <option value="">Chargement...</option>
                        </select>
                    </div>
                    <button onclick="activateSession()" id="activateBtn" disabled>Activer</button>
                    <button onclick="showCreateSessionModal()" class="create-session-btn">Nouvelle Session</button>
                </div>
            </div>

            <!-- Section Progr√®s -->
            <div class="progress-section" id="progressSection" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="currentDrawStat">-</div>
                        <div class="stat-label">Tirage Actuel</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalDrawsStat">-</div>
                        <div class="stat-label">Total Tirages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completedStat">-</div>
                        <div class="stat-label">Compl√©t√©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="progressStat">-%</div>
                        <div class="stat-label">Progr√®s</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <p style="text-align: center; margin: 0; color: #666;" id="sessionInfo">Session: -</p>
            </div>

            <!-- Section Saisie -->
            <div class="draw-input-section" id="drawInputSection" style="display: none;">
                <div class="draw-header">
                    <h2 class="draw-title" id="drawTitle">Tirage #1</h2>
                    <p class="draw-subtitle" id="drawSubtitle">Saisissez les num√©ros gagnants</p>
                </div>

                <!-- Champs nom et date -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                    <div class="form-group">
                        <label for="drawName">Nom du Tirage:</label>
                        <input type="text" id="drawName" placeholder="Ex: Loto du Samedi" style="text-align: left;">
                    </div>
                    <div class="form-group">
                        <label for="drawDate">Date du Tirage:</label>
                        <input type="date" id="drawDate">
                    </div>
                </div>

                <div class="numbers-grid" id="numbersGrid">
                    <!-- Les champs seront g√©n√©r√©s dynamiquement -->
                </div>

                <div class="action-buttons">
                    <button onclick="saveCurrentDraw()" class="save-btn" id="saveBtn" disabled>
                        üíæ Sauvegarder
                    </button>
                    <button onclick="nextDraw()" class="next-btn" id="nextBtn" disabled>
                        ‚û°Ô∏è Tirage Suivant
                    </button>
                    <button onclick="openStatisticalJournal()" style="background: #fa8c16; padding: 15px 30px; font-size: 16px;">
                        üìä Journal Statistique
                    </button>
                    <button onclick="showResultsHistory()" style="background: #722ed1; padding: 15px 30px; font-size: 16px;">
                        üìà Historique R√©sultats
                    </button>
                </div>

                <div id="messageContainer"></div>
            </div>

            <!-- Historique des r√©sultats -->
            <div id="resultsHistorySection" class="results-history-section" style="margin-top:40px; display:none; background:#f8f9fa; padding:30px; border-radius:15px;">
                <h2 id="historySessionTitle" style="text-align:center;color:#1890ff; margin-bottom:20px;">Historique des R√©sultats</h2>
                <div id="resultsHistory"></div>
                <div style="text-align:center; margin-top:20px;">
                    <button onclick="showResultsHistory()" style="background:#ff4d4f; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">
                        ‚ùå Masquer l'Historique
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cr√©ation Session -->
    <div id="createSessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeCreateSessionModal()">&times;</span>
                <h2 style="margin: 0; color: #1890ff;">üÜï Nouvelle Session de Travail</h2>
            </div>
            <form class="modal-form" id="createSessionForm">
                <div class="form-group">
                    <label for="sessionName">Nom de la Session:</label>
                    <input type="text" id="sessionName" placeholder="Ex: Session Janvier 2025" required>
                </div>
                
                <div class="form-group">
                    <label for="sessionDescription">Description (optionnelle):</label>
                    <input type="text" id="sessionDescription" placeholder="Description de la session">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="lotteryType">Type de Loto:</label>
                        <input type="text" id="lotteryType" placeholder="Ex: Loto Fran√ßais" required>
                    </div>
                    <div class="form-group">
                        <label for="numbersPerDraw">Num√©ros par Tirage:</label>
                        <input type="number" id="numbersPerDraw" min="3" max="10" value="6" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="totalDraws">Nombre de Tirages:</label>
                        <input type="number" id="totalDraws" min="1" max="100" value="21" required>
                    </div>
                    <div class="form-group">
                        <label for="numberRange">Plage de Num√©ros:</label>
                        <select id="numberRange">
                            <option value="1-49">1 √† 49</option>
                            <option value="1-90" selected>1 √† 90</option>
                            <option value="1-99">1 √† 99</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="startDate">Date de D√©but de la Session:</label>
                    <input type="date" id="startDate" required>
                </div>
                
                <!-- Planning des Lotos -->
                <div class="form-group">
                    <label>Planning Hebdomadaire des Lotos:</label>
                    <div id="lotterySchedule" style="border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: bold; width: 80px;">Jour</span>
                            <span style="font-weight: bold;">Nom de la Loto</span>
                            <span style="font-weight: bold; width: 80px;">Action</span>
                        </div>
                        <div id="scheduleItems">
                            <!-- Les √©l√©ments du planning seront ajout√©s ici -->
                        </div>
                        <div style="margin-top: 15px;">
                            <select id="daySelect" style="width: 120px; margin-right: 10px;">
                                <option value="0">Lundi</option>
                                <option value="1">Mardi</option>
                                <option value="2">Mercredi</option>
                                <option value="3">Jeudi</option>
                                <option value="4">Vendredi</option>
                                <option value="5">Samedi</option>
                                <option value="6">Dimanche</option>
                            </select>
                            <input type="text" id="lotteryNameInput" placeholder="Nom de la loto" style="flex: 1; margin-right: 10px;">
                            <button type="button" onclick="addLotteryToSchedule()" style="width: auto; padding: 8px 15px;">
                                ‚ûï Ajouter
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button type="submit" style="padding: 15px 30px; font-size: 16px;">
                        ‚ú® Cr√©er la Session Cyclique
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let currentSession = null;
        let currentDrawData = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadSessions();
            loadActiveSession();
        });

        // Gestion des sessions avec donn√©es de test
        async function loadSessions() {
            try {
                // Utiliser des donn√©es de test
                const sessions = [
                    { id: 1, name: 'Session Test 1', current_draw: 5, total_draws: 21, is_active: true },
                    { id: 2, name: 'Session Test 2', current_draw: 12, total_draws: 21, is_active: false },
                    { id: 3, name: 'Session Janvier 2025', current_draw: 1, total_draws: 21, is_active: false }
                ];
                
                const select = document.getElementById('sessionSelect');
                select.innerHTML = '<option value="">S√©lectionner une session</option>';
                
                sessions.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.id;
                    option.textContent = `${session.name} (${session.current_draw}/${session.total_draws})`;
                    if (session.is_active) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                document.getElementById('activateBtn').disabled = false;
                console.log(`‚úÖ ${sessions.length} sessions charg√©es`);
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                document.getElementById('sessionSelect').innerHTML = '<option value="">Erreur de chargement</option>';
            }
        }

        async function loadActiveSession() {
            try {
                // Session de test
                currentSession = {
                    id: 1,
                    name: 'Session Test 1',
                    numbers_per_draw: 6,
                    number_range_min: 1,
                    number_range_max: 49
                };
                
                const progress = {
                    current_draw: 5,
                    total_draws: 21,
                    completed_draws: 4,
                    progress_percentage: 19,
                    session_name: 'Session Test 1'
                };
                
                updateProgressDisplay(progress);
                await loadCurrentDraw();
                
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function activateSession() {
            const sessionId = document.getElementById('sessionSelect').value;
            if (!sessionId) {
                showMessage('Veuillez s√©lectionner une session', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/session/sessions/${sessionId}/activate`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(result.message, 'success');
                    await loadActiveSession();
                } else {
                    showMessage('Erreur lors de l\'activation: ' + result.detail, 'error');
                }
                
            } catch (error) {
                showMessage('Erreur de connexion: ' + error.message, 'error');
            }
        }

        function updateProgressDisplay(progress) {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('drawInputSection').style.display = 'block';
            
            document.getElementById('currentDrawStat').textContent = progress.current_draw;
            document.getElementById('totalDrawsStat').textContent = progress.total_draws;
            document.getElementById('completedStat').textContent = progress.completed_draws;
            document.getElementById('progressStat').textContent = progress.progress_percentage + '%';
            document.getElementById('progressFill').style.width = progress.progress_percentage + '%';
            document.getElementById('sessionInfo').textContent = `Session: ${progress.session_name}`;
        }

        async function loadCurrentDraw() {
            if (!currentSession) return;

            try {
                // Tirage de test
                const draw = {
                    draw_number: 5,
                    lottery_name: 'Loto Test',
                    draw_date: new Date().toLocaleDateString('fr-FR'),
                    is_completed: false,
                    winning_numbers: []
                };
                
                currentDrawData = draw;
                setupDrawInput(draw);
                
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function setupDrawInput(draw) {
            document.getElementById('drawTitle').textContent = draw.lottery_name;
            document.getElementById('drawSubtitle').textContent = `Tirage #${draw.draw_number} - ${draw.draw_date}`;
            
            // G√©n√©rer les champs de saisie
            const numbersGrid = document.getElementById('numbersGrid');
            numbersGrid.innerHTML = '';
            
            for (let i = 1; i <= currentSession.numbers_per_draw; i++) {
                const numberInput = document.createElement('div');
                numberInput.className = 'number-input';
                numberInput.innerHTML = `
                    <label>N¬∞${i}</label>
                    <input 
                        type="number" 
                        id="num${i}" 
                        min="${currentSession.number_range_min}" 
                        max="${currentSession.number_range_max}"
                        placeholder="${i}"
                        oninput="handleNumberInput(${i})"
                        onkeydown="handleKeyDown(event, ${i})"
                    >
                `;
                numbersGrid.appendChild(numberInput);
            }
            
            // Pr√©-remplir si le tirage est d√©j√† compl√©t√©
            if (draw.is_completed && draw.winning_numbers.length > 0) {
                draw.winning_numbers.forEach((num, index) => {
                    const input = document.getElementById(`num${index + 1}`);
                    if (input) {
                        input.value = num;
                        input.classList.add('filled');
                    }
                });
                updateButtonStates();
            }
            
            // Focus sur le premier champ
            setTimeout(() => {
                document.getElementById('num1').focus();
            }, 100);
        }

        function handleNumberInput(position) {
            const input = document.getElementById(`num${position}`);
            let value = input.value;
            
            // Validation
            input.classList.remove('error', 'filled');
            
            // Passer au champ suivant automatiquement si 2 chiffres ou plus
            if (value.length >= 2) {
                const numValue = parseInt(value);
                
                if (numValue) {
                    // V√©rifier la plage
                    if (numValue < currentSession.number_range_min || numValue > currentSession.number_range_max) {
                        input.classList.add('error');
                        return;
                    }
                    
                    // V√©rifier les doublons
                    if (checkDuplicate(numValue, position)) {
                        input.classList.add('error');
                        return;
                    }
                    
                    input.classList.add('filled');
                    
                    // Passer au champ suivant automatiquement
                    if (position < currentSession.numbers_per_draw) {
                        const nextInput = document.getElementById(`num${position + 1}`);
                        if (nextInput && !nextInput.value) {
                            setTimeout(() => nextInput.focus(), 100);
                        }
                    }
                }
            } else if (value.length === 1) {
                const numValue = parseInt(value);
                if (numValue) {
                    // Validation pour les nombres √† 1 chiffre aussi
                    if (numValue < currentSession.number_range_min || numValue > currentSession.number_range_max) {
                        input.classList.add('error');
                        return;
                    }
                    
                    if (checkDuplicate(numValue, position)) {
                        input.classList.add('error');
                        return;
                    }
                    
                    input.classList.add('filled');
                }
            }
            
            updateButtonStates();
        }

        function handleKeyDown(event, position) {
            // Navigation avec les fl√®ches
            if (event.key === 'ArrowRight' && position < currentSession.numbers_per_draw) {
                document.getElementById(`num${position + 1}`).focus();
            } else if (event.key === 'ArrowLeft' && position > 1) {
                document.getElementById(`num${position - 1}`).focus();
            }
        }

        function checkDuplicate(value, currentPosition) {
            for (let i = 1; i <= currentSession.numbers_per_draw; i++) {
                if (i !== currentPosition) {
                    const otherInput = document.getElementById(`num${i}`);
                    if (otherInput && parseInt(otherInput.value) === value) {
                        return true;
                    }
                }
            }
            return false;
        }

        function updateButtonStates() {
            const numbers = getCurrentNumbers();
            const isComplete = numbers.length === currentSession.numbers_per_draw && 
                              numbers.every(n => n !== null);
            
            document.getElementById('saveBtn').disabled = !isComplete;
            document.getElementById('nextBtn').disabled = !isComplete;
        }

        function getCurrentNumbers() {
            const numbers = [];
            for (let i = 1; i <= currentSession.numbers_per_draw; i++) {
                const input = document.getElementById(`num${i}`);
                const value = parseInt(input.value);
                numbers.push(value || null);
            }
            return numbers.filter(n => n !== null);
        }

        async function saveCurrentDraw() {
            const numbers = getCurrentNumbers();
            
            if (numbers.length !== currentSession.numbers_per_draw) {
                showMessage('Veuillez remplir tous les num√©ros', 'error');
                return;
            }

            try {
                const response = await fetch(
                    `${API_BASE}/session/sessions/${currentSession.id}/draws/${currentDrawData.draw_number}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            numbers: numbers,
                            draw_date: new Date().toLocaleDateString('fr-FR')
                        })
                    }
                );
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('‚úÖ Tirage sauvegard√© avec succ√®s!', 'success');
                    await loadActiveSession(); // Recharger pour mettre √† jour le progr√®s
                } else {
                    showMessage('Erreur lors de la sauvegarde: ' + result.detail, 'error');
                }
                
            } catch (error) {
                showMessage('Erreur de connexion: ' + error.message, 'error');
            }
        }

        async function nextDraw() {
            await saveCurrentDraw();
            setTimeout(async () => {
                await loadCurrentDraw();
                clearInputs();
            }, 1000);
        }

        function clearInputs() {
            for (let i = 1; i <= currentSession.numbers_per_draw; i++) {
                const input = document.getElementById(`num${i}`);
                if (input) {
                    input.value = '';
                    input.classList.remove('filled', 'error');
                }
            }
            document.getElementById('num1').focus();
            updateButtonStates();
        }

        // Gestion du modal
        function showCreateSessionModal() {
            document.getElementById('createSessionModal').style.display = 'block';
        }

        function closeCreateSessionModal() {
            document.getElementById('createSessionModal').style.display = 'none';
            document.getElementById('createSessionForm').reset();
        }

        document.getElementById('createSessionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const range = document.getElementById('numberRange').value.split('-');
            const sessionData = {
                name: document.getElementById('sessionName').value,
                description: document.getElementById('sessionDescription').value,
                lottery_type: document.getElementById('lotteryType').value,
                numbers_per_draw: parseInt(document.getElementById('numbersPerDraw').value),
                total_draws: parseInt(document.getElementById('totalDraws').value),
                number_range_min: parseInt(range[0]),
                number_range_max: parseInt(range[1])
            };

            try {
                const response = await fetch(`${API_BASE}/session/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sessionData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('‚ú® Session cr√©√©e avec succ√®s!', 'success');
                    closeCreateSessionModal();
                    await loadSessions();
                    await loadActiveSession();
                } else {
                    showMessage('Erreur lors de la cr√©ation: ' + result.detail, 'error');
                }
                
            } catch (error) {
                showMessage('Erreur de connexion: ' + error.message, 'error');
            }
        });

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const className = type === 'success' ? 'success-message' : 'error-message';
            
            container.innerHTML = `<div class="${className}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Charger et afficher l'historique des r√©sultats
        async function loadResultsHistory() {
            if (!currentSession) return;
            try {
                // Donn√©es de test
                const draws = [
                    { id: 1, draw_number: 4, draw_date: '15/01/2025', winning_numbers: [7, 14, 21, 28, 35, 42] },
                    { id: 2, draw_number: 3, draw_date: '14/01/2025', winning_numbers: [3, 12, 19, 26, 33, 40] },
                    { id: 3, draw_number: 2, draw_date: '13/01/2025', winning_numbers: [5, 11, 18, 25, 32, 39] },
                    { id: 4, draw_number: 1, draw_date: '12/01/2025', winning_numbers: [1, 8, 15, 22, 29, 36] }
                ];
                displayResultsHistory(draws);
            } catch (error) {
                showMessage('Erreur lors du chargement de l\'historique', 'error');
            }
        }
        
        // Fonction pour afficher/masquer l'historique
        function showResultsHistory() {
            const section = document.getElementById('resultsHistorySection');
            if (section.style.display === 'none' || !section.style.display) {
                section.style.display = 'block';
                loadResultsHistory();
            } else {
                section.style.display = 'none';
            }
        }

        // Affichage de l'historique, tri descendant, s√©parateurs de p√©riodes
        function displayResultsHistory(draws) {
            const container = document.getElementById('resultsHistory');
            const title = document.getElementById('historySessionTitle');
            if (!draws || draws.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#888;">Aucun r√©sultat enregistr√©</p>';
                title.textContent = '';
                return;
            }
            // Nom de la session en titre
            title.textContent = currentSession.name;
            // Tri descendant (plus r√©cent en haut)
            draws.sort((a, b) => b.draw_number - a.draw_number);
            // Regroupement par p√©riodes
            const drawsPerPeriod = currentSession.numbers_per_draw || 7;
            let html = '';
            let lastPeriod = null;
            draws.forEach((draw, idx) => {
                const period = Math.floor((draw.draw_number - 1) / drawsPerPeriod) + 1;
                if (period !== lastPeriod) {
                    if (lastPeriod !== null) {
                        html += '<div style="height:6px;background:#ff4d4f;margin:30px 0;border-radius:3px;"></div>';
                    }
                    html += `<div style='font-weight:bold;color:#faad14;margin:20px 0 10px 0;'>P√©riode ${period}</div>`;
                    lastPeriod = period;
                }
                html += `<div class='result-item' style='background:#f8f9fa;padding:15px 20px;margin-bottom:10px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;'>` +
                    `<div><b>#${draw.draw_number}</b> | <span style='color:#1890ff;'>${draw.draw_date || ''}</span> : <span>${(draw.winning_numbers||[]).join(' - ')}</span></div>` +
                    `<div><button onclick='editResult(${draw.id})' style='background:#1890ff;color:white;border:none;padding:5px 12px;border-radius:5px;cursor:pointer;'>‚úèÔ∏è</button></div>` +
                    `</div>`;
            });
            container.innerHTML = html;
        }

        // Edition d'un r√©sultat (affiche un prompt simple pour la d√©mo)
        async function editResult(drawId) {
            const response = await fetch(`${API_BASE}/session/sessions/${currentSession.id}/draws`);
            const draws = await response.json();
            const draw = draws.find(d => d.id === drawId);
            if (!draw) return;
            const newDate = prompt('Nouvelle date du tirage (JJ/MM/AAAA) :', draw.draw_date || '');
            const newNumbers = prompt('Nouveaux num√©ros (s√©par√©s par un espace) :', (draw.winning_numbers||[]).join(' '));
            if (newDate && newNumbers) {
                const numbersArr = newNumbers.split(/\s+/).map(x => parseInt(x)).filter(x => !isNaN(x));
                await fetch(`${API_BASE}/session/sessions/${currentSession.id}/draws/${draw.draw_number}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numbers: numbersArr, draw_date: newDate })
                });
                await loadResultsHistory();
                showMessage('R√©sultat modifi√©', 'success');
            }
        }

        // Appel dans loadActiveSession et saveCurrentDraw
        const originalLoadActiveSession = loadActiveSession;
        loadActiveSession = async function() {
            await originalLoadActiveSession.apply(this, arguments);
            await loadResultsHistory();
        };
        const originalSaveCurrentDraw = saveCurrentDraw;
        saveCurrentDraw = async function() {
            await originalSaveCurrentDraw.apply(this, arguments);
            await loadResultsHistory();
        };

        // Fonction pour ouvrir le journal statistique
        function openStatisticalJournal() {
            if (!currentSession) {
                showMessage('Aucune session active. Veuillez d\'abord activer une session.', 'error');
                return;
            }
            
            // Rediriger vers le journal avec l'ID de session
            const url = `advanced-journal.html?session=${currentSession.id}&universe=mundo`;
            window.open(url, '_blank');
        }

        // Fermer le modal en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modal = document.getElementById('createSessionModal');
            if (event.target === modal) {
                closeCreateSessionModal();
            }
        }
    </script>
</body>
</html>