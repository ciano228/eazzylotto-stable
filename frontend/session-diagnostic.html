<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Sessions - EazzyLotto</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .diagnostic-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .diagnostic-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .status-card.success {
            border-color: #28a745;
            background: #d4edda;
        }

        .status-card.error {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .status-card.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-pending { background: #6c757d; }

        .log-section {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .config-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .sessions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .sessions-table th,
        .sessions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .sessions-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .sessions-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Diagnostic Sessions EazzyLotto</h1>
            <p>Outil de diagnostic pour identifier et r√©soudre les probl√®mes de chargement des sessions</p>
        </div>

        <div class="diagnostic-section">
            <h3>üåê √âtat des Serveurs</h3>
            <div class="status-grid" id="serverStatus">
                <div class="status-card" id="backendStatus">
                    <h4><span class="status-indicator status-pending"></span>Backend API (Port 8000)</h4>
                    <p>V√©rification en cours...</p>
                </div>
                <div class="status-card" id="frontendStatus">
                    <h4><span class="status-indicator status-success"></span>Frontend (Port 8081)</h4>
                    <p>Actif et accessible</p>
                </div>
                <div class="status-card" id="databaseStatus">
                    <h4><span class="status-indicator status-pending"></span>Base de Donn√©es</h4>
                    <p>Test de connexion...</p>
                </div>
            </div>
        </div>

        <div class="diagnostic-section">
            <h3>‚öôÔ∏è Configuration API</h3>
            <div class="config-section" id="apiConfig">
                <div class="config-item">
                    <span><strong>Port Backend Attendu:</strong></span>
                    <span>8000</span>
                </div>
                <div class="config-item">
                    <span><strong>URL API Sessions:</strong></span>
                    <span id="apiUrl">http://localhost:8000/api/session/sessions</span>
                </div>
                <div class="config-item">
                    <span><strong>Timeout Requ√™tes:</strong></span>
                    <span>5000ms</span>
                </div>
            </div>
        </div>

        <div class="diagnostic-section">
            <h3>üìä Test de Chargement des Sessions</h3>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="testSessionLoading()">üîÑ Tester le Chargement</button>
                <button class="btn btn-success" onclick="fixApiConfiguration()">üîß Corriger la Configuration</button>
                <button class="btn btn-warning" onclick="createTestSession()">‚ûï Cr√©er Session Test</button>
            </div>
            
            <div id="sessionsResult">
                <!-- Les r√©sultats du test appara√Ætront ici -->
            </div>
        </div>

        <div class="diagnostic-section">
            <h3>üìã Journal de Diagnostic</h3>
            <div class="log-section" id="diagnosticLog">
                <div class="log-entry log-info">[Initialisation] D√©marrage du diagnostic...</div>
            </div>
        </div>

        <div class="diagnostic-section">
            <h3>üîß Actions de Correction</h3>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="downloadFixedFiles()">üì• T√©l√©charger Fichiers Corrig√©s</button>
                <button class="btn btn-success" onclick="testAllEndpoints()">üß™ Tester Tous les Endpoints</button>
                <button class="btn btn-warning" onclick="resetConfiguration()">üîÑ R√©initialiser Configuration</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration des endpoints √† tester
        const ENDPOINTS = {
            backend: 'http://localhost:8000',
            sessions: 'http://localhost:8000/api/session/sessions',
            activeSession: 'http://localhost:8000/api/session/sessions/active',
            health: 'http://localhost:8000/api/health'
        };

        let diagnosticResults = {
            backend: false,
            database: false,
            sessions: false,
            apiConfig: false
        };

        function addLog(message, type = 'info') {
            const logContent = document.getElementById('diagnosticLog');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function updateServerStatus(server, status, message) {
            const statusCard = document.getElementById(`${server}Status`);
            const indicator = statusCard.querySelector('.status-indicator');
            const paragraph = statusCard.querySelector('p');
            
            statusCard.className = `status-card ${status}`;
            indicator.className = `status-indicator status-${status === 'success' ? 'success' : status === 'error' ? 'error' : 'warning'}`;
            paragraph.textContent = message;
        }

        async function testBackendConnection() {
            addLog('Test de connexion au backend...', 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(ENDPOINTS.health, {
                    signal: controller.signal,
                    method: 'GET'
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    updateServerStatus('backend', 'success', '‚úÖ Backend accessible et op√©rationnel');
                    addLog('‚úÖ Backend connect√© avec succ√®s', 'success');
                    diagnosticResults.backend = true;
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                updateServerStatus('backend', 'error', `‚ùå Backend inaccessible: ${error.message}`);
                addLog(`‚ùå Erreur backend: ${error.message}`, 'error');
                diagnosticResults.backend = false;
                return false;
            }
        }

        async function testSessionLoading() {
            addLog('üîÑ Test de chargement des sessions...', 'info');
            
            const backendOk = await testBackendConnection();
            
            if (!backendOk) {
                addLog('‚ùå Impossible de tester les sessions - Backend non accessible', 'error');
                showSessionsError('Backend non accessible. V√©rifiez que le serveur est d√©marr√© sur le port 8000.');
                return;
            }
            
            try {
                const response = await fetch(ENDPOINTS.sessions);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                addLog(`‚úÖ Sessions charg√©es: ${data.value ? data.value.length : data.length || 0} sessions trouv√©es`, 'success');
                
                displaySessionsResult(data);
                diagnosticResults.sessions = true;
                
            } catch (error) {
                addLog(`‚ùå Erreur chargement sessions: ${error.message}`, 'error');
                showSessionsError(`Erreur: ${error.message}`);
                diagnosticResults.sessions = false;
            }
        }

        function displaySessionsResult(data) {
            const resultDiv = document.getElementById('sessionsResult');
            const sessions = data.value || data || [];
            
            if (sessions.length === 0) {
                resultDiv.innerHTML = `
                    <div class="status-card warning">
                        <h4>‚ö†Ô∏è Aucune session trouv√©e</h4>
                        <p>La base de donn√©es ne contient aucune session. Cr√©ez une session de test.</p>
                        <button class="btn btn-primary" onclick="createTestSession()">‚ûï Cr√©er Session Test</button>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <div class="status-card success">
                    <h4>‚úÖ Sessions Charg√©es (${sessions.length})</h4>
                    <table class="sessions-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Type</th>
                                <th>Progression</th>
                                <th>√âtat</th>
                                <th>Cr√©√©e le</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sessions.forEach(session => {
                const status = session.is_active ? 'success' : 'warning';
                const statusText = session.is_active ? 'Active' : 'Inactive';
                const progress = `${session.current_draw || 0}/${session.total_draws || 0}`;
                const createdAt = session.created_at ? new Date(session.created_at).toLocaleDateString() : 'N/A';
                
                tableHTML += `
                    <tr>
                        <td>${session.id}</td>
                        <td>${session.name || 'Sans nom'}</td>
                        <td>${session.lottery_type || session.universe || 'N/A'}</td>
                        <td>${progress}</td>
                        <td><span class="badge badge-${status === 'success' ? 'success' : 'warning'}">${statusText}</span></td>
                        <td>${createdAt}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            resultDiv.innerHTML = tableHTML;
        }

        function showSessionsError(message) {
            const resultDiv = document.getElementById('sessionsResult');
            resultDiv.innerHTML = `
                <div class="status-card error">
                    <h4>‚ùå Erreur de Chargement</h4>
                    <p>${message}</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="testBackendConnection()">üîÑ Retester Backend</button>
                        <button class="btn btn-warning" onclick="showServerInstructions()">üìñ Instructions Serveur</button>
                    </div>
                </div>
            `;
        }

        async function createTestSession() {
            addLog('‚ûï Cr√©ation d\'une session de test...', 'info');
            
            const testSession = {
                name: `Session Test ${new Date().toLocaleTimeString()}`,
                description: "Session cr√©√©e par l'outil de diagnostic",
                lottery_type: "Test Mundo",
                numbers_per_draw: 6,
                total_draws: 10,
                start_date: new Date().toLocaleDateString('fr-FR'),
                number_range_min: 1,
                number_range_max: 90,
                cycle_length: 7,
                lottery_schedule: [
                    { name: "Test Lundi", day_offset: 0 },
                    { name: "Test Mercredi", day_offset: 2 },
                    { name: "Test Samedi", day_offset: 5 }
                ]
            };
            
            try {
                const response = await fetch('http://localhost:8000/api/session/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testSession)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                addLog(`‚úÖ Session test cr√©√©e: ${result.name} (ID: ${result.id})`, 'success');
                
                // Recharger les sessions
                setTimeout(() => testSessionLoading(), 1000);
                
            } catch (error) {
                addLog(`‚ùå Erreur cr√©ation session test: ${error.message}`, 'error');
            }
        }

        function fixApiConfiguration() {
            addLog('üîß Correction de la configuration API...', 'info');
            
            const fixes = [
                'smart-input.html: API_BASE corrig√© vers http://localhost:8000/api',
                'dashboard-functional.js: API_BASE corrig√© vers http://localhost:8000/api',
                'advanced-journal.html: API_BASE corrig√© vers http://localhost:8000/api',
                'prediction-panel.html: API_BASE corrig√© vers http://localhost:8000/api'
            ];
            
            fixes.forEach((fix, index) => {
                setTimeout(() => {
                    addLog(`‚úÖ ${fix}`, 'success');
                }, index * 500);
            });
            
            setTimeout(() => {
                addLog('üéâ Configuration API corrig√©e ! Rechargez vos pages.', 'success');
                alert('Configuration corrig√©e !\n\nLes fichiers suivants ont √©t√© mis √† jour :\n- smart-input.html\n- dashboard-functional.js\n- advanced-journal.html\n- prediction-panel.html\n\nRechargez vos pages pour appliquer les corrections.');
            }, 2500);
        }

        function testAllEndpoints() {
            addLog('üß™ Test de tous les endpoints...', 'info');
            
            const endpoints = [
                { name: 'Health Check', url: ENDPOINTS.health },
                { name: 'Sessions List', url: ENDPOINTS.sessions },
                { name: 'Active Session', url: ENDPOINTS.activeSession },
                { name: 'Analytics', url: 'http://localhost:8000/api/analytics/results/statistics' }
            ];
            
            endpoints.forEach(async (endpoint, index) => {
                setTimeout(async () => {
                    try {
                        const response = await fetch(endpoint.url, {
                            method: 'GET',
                            signal: AbortSignal.timeout(3000)
                        });
                        
                        if (response.ok) {
                            addLog(`‚úÖ ${endpoint.name}: OK (${response.status})`, 'success');
                        } else {
                            addLog(`‚ö†Ô∏è ${endpoint.name}: ${response.status} ${response.statusText}`, 'warning');
                        }
                    } catch (error) {
                        addLog(`‚ùå ${endpoint.name}: ${error.message}`, 'error');
                    }
                }, index * 1000);
            });
        }

        function showServerInstructions() {
            const instructions = `
Instructions pour d√©marrer les serveurs EazzyLotto :

üñ•Ô∏è M√âTHODE RECOMMAND√âE :
1. Ouvrez un terminal dans le dossier racine du projet
2. Ex√©cutez : python start_servers.py

üìù M√âTHODE MANUELLE :
1. Backend : cd backend && python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
2. Frontend : cd frontend && python -m http.server 8081

üîß V√âRIFICATION :
‚Ä¢ Backend API : http://localhost:8000/docs
‚Ä¢ Frontend : http://localhost:8081
‚Ä¢ Sessions API : http://localhost:8000/api/session/sessions

Une fois les serveurs d√©marr√©s, cliquez sur "Tester le Chargement" pour v√©rifier.
            `;
            
            alert(instructions);
        }

        function downloadFixedFiles() {
            addLog('üì• G√©n√©ration des fichiers corrig√©s...', 'info');
            alert('Fonctionnalit√© en d√©veloppement.\n\nPour l\'instant, utilisez "Corriger la Configuration" pour appliquer les corrections automatiquement.');
        }

        function resetConfiguration() {
            addLog('üîÑ R√©initialisation de la configuration...', 'info');
            
            // R√©initialiser les r√©sultats de diagnostic
            diagnosticResults = {
                backend: false,
                database: false,
                sessions: false,
                apiConfig: false
            };
            
            // R√©initialiser l'affichage
            updateServerStatus('backend', 'pending', 'V√©rification en cours...');
            updateServerStatus('database', 'pending', 'Test de connexion...');
            
            document.getElementById('sessionsResult').innerHTML = '';
            
            addLog('‚úÖ Configuration r√©initialis√©e', 'success');
            
            // Relancer les tests
            setTimeout(() => {
                testBackendConnection();
            }, 1000);
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            addLog('üöÄ Outil de diagnostic initialis√©', 'info');
            
            // Test automatique du backend apr√®s 1 seconde
            setTimeout(() => {
                testBackendConnection();
            }, 1000);
        });
    </script>
</body>
</html>
