<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Katula Dynamique - Tous Univers</title>
    <script src="assets/js/universal-header.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            color: #2c3e50;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        select, button {
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            min-width: 150px;
        }

        button {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3);
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .universe-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #2196f3;
        }

        .katula-grid {
            display: grid;
            grid-template-columns: 80px repeat(6, 1fr);
            grid-template-rows: 40px repeat(8, 1fr);
            gap: 4px;
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            position: relative;
            align-items: stretch;
            justify-items: stretch;
        }
        
        /* Axes de repère orthonormé - lignes rouges traversant toute la grille */
        .katula-grid::before {
            content: '';
            position: absolute;
            /* Axe horizontal - entre L4 et L5, traverse de gauche à droite */
            top: calc(40px + (4 * (100% - 60px) / 8) + (4 * 4px) + 2px);
            left: 20px;
            right: 20px;
            height: 4px;
            background: #dc3545;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.9);
            z-index: 30;
        }
        
        .katula-grid::after {
            content: '';
            position: absolute;
            /* Axe vertical - entre C3 et C4, traverse de haut en bas */
            left: calc(80px + (3 * (100% - 100px) / 6) + (3 * 4px) + 2px);
            top: 20px;
            bottom: 20px;
            width: 4px;
            background: #dc3545;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.9);
            z-index: 30;
        }
        
        /* Lignes de séparation rouges selon l'image */
        .separation-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 20;
        }
        
        .horizontal-line {
            position: absolute;
            /* Ligne horizontale : après la 4ème ligne de chips (entre L4 et L5) */
            top: calc(50% + 1.5px);
            left: calc(14.28% + 5px); /* Après la colonne des labels */
            right: 15px;
            height: 3px;
            background: #dc3545;
            border-radius: 1px;
            box-shadow: 0 0 3px rgba(220, 53, 69, 0.6);
            z-index: 25;
        }
        
        .vertical-line {
            position: absolute;
            /* Ligne verticale : après la 3ème colonne de chips (entre C3 et C4) */
            left: calc(50% + 1.5px);
            top: calc(12.5% + 5px); /* Après la ligne des headers */
            bottom: 15px;
            width: 3px;
            background: #dc3545;
            border-radius: 1px;
            box-shadow: 0 0 3px rgba(220, 53, 69, 0.6);
            z-index: 25;
        }

        .grid-header {
            background: #34495e;
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
        }
        
        .clickable-header {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clickable-header:hover {
            background: #2c3e50;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .ligne-label {
            background: #2c3e50;
            color: white;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .ligne-label.clickable-header:hover {
            background: #34495e;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .chip-cell {
            background: white;
            border: 2px solid #34495e;
            border-radius: 8px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .chip-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Labels des quadrants */
        .quadrant-label {
            position: absolute;
            font-weight: bold;
            font-size: 0.9em;
            color: #2c3e50;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 3px;
            z-index: 15;
        }
        
        .clickable-quadrant {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clickable-quadrant:hover {
            background: rgba(52, 152, 219, 0.9);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.5);
        }
        
        /* Styles pour les granques (Q majuscule) */
        .granque-label {
            position: absolute;
            font-weight: bold;
            font-size: 1.2em;
            color: #e74c3c;
            background: rgba(255, 255, 255, 0.95);
            padding: 4px 8px;
            border-radius: 5px;
            border: 2px solid #e74c3c;
            z-index: 20;
        }
        
        .granque-q1 {
            top: 10px;
            left: 20%;
            transform: translateX(-50%);
        }
        
        .granque-q2 {
            top: 10px;
            right: 20%;
            transform: translateX(50%);
        }
        
        .granque-q3 {
            bottom: 10px;
            left: 20%;
            transform: translateX(-50%);
        }
        
        .granque-q4 {
            bottom: 10px;
            right: 20%;
            transform: translateX(50%);
        }
        
        .clickable-granque {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clickable-granque:hover {
            background: rgba(231, 76, 60, 0.9);
            color: white;
            transform: scale(1.15);
            box-shadow: 0 3px 12px rgba(231, 76, 60, 0.6);
        }
        
        /* Différenciation visuelle petique vs granque */
        .petique-label {
            font-size: 0.9em;
            border: 1px solid #3498db;
        }
        
        .petique-label:hover {
            border-color: #2980b9;
        }
        
        .quadrant-q1 {
            top: 20px;
            left: 25%;
            transform: translateX(-50%);
        }
        
        .quadrant-q2 {
            top: 20px;
            right: 25%;
            transform: translateX(50%);
        }
        
        .quadrant-q3 {
            bottom: 20px;
            left: 25%;
            transform: translateX(-50%);
        }
        
        .quadrant-q4 {
            bottom: 20px;
            right: 25%;
            transform: translateX(50%);
        }
        
        /* Les lignes de séparation sont maintenant créées avec ::before et ::after */
        
        .chip-cell.selected-quadrant {
            border: 5px solid;
            animation: quadrantPulse 1.5s infinite;
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.4);
            z-index: 10;
        }
        
        .chip-cell.selected-quadrant.quadrant-q1 {
            border-color: #3498db;
            animation: quadrantPulseBlue 2s infinite;
        }
        
        .chip-cell.selected-quadrant.quadrant-q2 {
            border-color: #27ae60;
            animation: quadrantPulseGreen 2s infinite;
        }
        
        .chip-cell.selected-quadrant.quadrant-q3 {
            border-color: #f39c12;
            animation: quadrantPulseOrange 2s infinite;
        }
        
        .chip-cell.selected-quadrant.quadrant-q4 {
            border-color: #9b59b6;
            animation: quadrantPulsePurple 2s infinite;
        }
        
        @keyframes quadrantPulseBlue {
            0%, 100% { 
                border-color: #3498db; 
                box-shadow: 0 0 20px rgba(52, 152, 219, 0.6), 0 0 40px rgba(52, 152, 219, 0.3);
                transform: scale(1.05);
            }
            50% { 
                border-color: #85c1e9; 
                box-shadow: 0 0 35px rgba(52, 152, 219, 0.9), 0 0 60px rgba(52, 152, 219, 0.5);
                transform: scale(1.08);
            }
        }
        
        @keyframes quadrantPulseGreen {
            0%, 100% { 
                border-color: #27ae60; 
                box-shadow: 0 0 20px rgba(39, 174, 96, 0.6), 0 0 40px rgba(39, 174, 96, 0.3);
                transform: scale(1.05);
            }
            50% { 
                border-color: #7fb3d3; 
                box-shadow: 0 0 35px rgba(39, 174, 96, 0.9), 0 0 60px rgba(39, 174, 96, 0.5);
                transform: scale(1.08);
            }
        }
        
        @keyframes quadrantPulseOrange {
            0%, 100% { 
                border-color: #f39c12; 
                box-shadow: 0 0 20px rgba(243, 156, 18, 0.6), 0 0 40px rgba(243, 156, 18, 0.3);
                transform: scale(1.05);
            }
            50% { 
                border-color: #f8c471; 
                box-shadow: 0 0 35px rgba(243, 156, 18, 0.9), 0 0 60px rgba(243, 156, 18, 0.5);
                transform: scale(1.08);
            }
        }
        
        @keyframes quadrantPulsePurple {
            0%, 100% { 
                border-color: #9b59b6; 
                box-shadow: 0 0 20px rgba(155, 89, 182, 0.6), 0 0 40px rgba(155, 89, 182, 0.3);
                transform: scale(1.05);
            }
            50% { 
                border-color: #d2b4de; 
                box-shadow: 0 0 35px rgba(155, 89, 182, 0.9), 0 0 60px rgba(155, 89, 182, 0.5);
                transform: scale(1.08);
            }
        }
        
        .quadrant-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .quadrant-btn {
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .quadrant-btn.q1 { border-color: #3498db; color: #3498db; }
        .quadrant-btn.q2 { border-color: #27ae60; color: #27ae60; }
        .quadrant-btn.q3 { border-color: #f39c12; color: #f39c12; }
        .quadrant-btn.q4 { border-color: #9b59b6; color: #9b59b6; }
        
        .quadrant-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .quadrant-btn.active.q1 { 
            background: #3498db; 
            color: white; 
            animation: buttonPulseBlue 2s infinite;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
        }
        .quadrant-btn.active.q2 { 
            background: #27ae60; 
            color: white; 
            animation: buttonPulseGreen 2s infinite;
            box-shadow: 0 0 15px rgba(39, 174, 96, 0.5);
        }
        .quadrant-btn.active.q3 { 
            background: #f39c12; 
            color: white; 
            animation: buttonPulseOrange 2s infinite;
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.5);
        }
        .quadrant-btn.active.q4 { 
            background: #9b59b6; 
            color: white; 
            animation: buttonPulsePurple 2s infinite;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.5);
        }
        
        @keyframes buttonPulseBlue {
            0%, 100% { box-shadow: 0 0 15px rgba(52, 152, 219, 0.5); }
            50% { box-shadow: 0 0 25px rgba(52, 152, 219, 0.8); }
        }
        
        @keyframes buttonPulseGreen {
            0%, 100% { box-shadow: 0 0 15px rgba(39, 174, 96, 0.5); }
            50% { box-shadow: 0 0 25px rgba(39, 174, 96, 0.8); }
        }
        
        @keyframes buttonPulseOrange {
            0%, 100% { box-shadow: 0 0 15px rgba(243, 156, 18, 0.5); }
            50% { box-shadow: 0 0 25px rgba(243, 156, 18, 0.8); }
        }
        
        @keyframes buttonPulsePurple {
            0%, 100% { box-shadow: 0 0 15px rgba(155, 89, 182, 0.5); }
            50% { box-shadow: 0 0 25px rgba(155, 89, 182, 0.8); }
        }
        
        /* Styles pour la modale interactive */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .modal-close {
            font-size: 2em;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .modal-close:hover {
            transform: scale(1.2);
            color: #e74c3c;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .modal-context {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .context-description {
            font-size: 1.1em;
            color: #2c3e50;
            font-weight: 500;
            text-align: center;
        }
        
        .modal-info {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .info-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            background: #3498db;
            color: white;
        }
        
        .info-badge.count {
            background: #27ae60;
        }
        
        .combinations-container {
            margin: 20px 0;
        }
        
        .denomination-group {
            margin-bottom: 25px;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            padding: 15px;
        }
        
        .denomination-group h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .combinations-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .combination-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .combination-number {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .combination-position {
            font-size: 0.9em;
            color: #7f8c8d;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 12px;
            background: #ecf0f1;
        }
        
        .combinations-grid {
            margin: 20px 0;
        }
        
        .combinations-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .combination-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .combination-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .combination-numbers {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .no-combinations {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 40px;
        }
        
        /* Couleurs pour les positions alphabétiques */
        .position-a { background: #e8f5e8; color: #27ae60; }
        .position-b { background: #e3f2fd; color: #2196f3; }
        .position-c { background: #fff3e0; color: #ff9800; }
        .position-d { background: #fce4ec; color: #e91e63; }
        .position-e { background: #f3e5f5; color: #9c27b0; }
        .position-f { background: #e0f2f1; color: #009688; }
        .position-na { background: #f5f5f5; color: #9e9e9e; }
        
        .show-more {
            grid-column: 1 / -1;
            text-align: center;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 5px;
            cursor: pointer;
            color: #2196f3;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        
        .show-more:hover {
            background: #bbdefb;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn-show-all, .btn-export, .btn-close {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-show-all {
            background: #3498db;
            color: white;
        }
        
        .btn-export {
            background: #f39c12;
            color: white;
        }
        
        .btn-close {
            background: #e74c3c;
            color: white;
        }
        
        .btn-show-all:hover, .btn-export:hover, .btn-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .chip-header {
            background: #34495e;
            color: white;
            text-align: center;
            padding: 5px;
            font-weight: bold;
            font-size: 0.8em;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s ease;
        }
        
        .chip-cell.selected-quadrant .chip-header {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            font-weight: bolder;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            animation: headerGlow 1.5s infinite;
        }
        
        @keyframes headerGlow {
            0%, 100% { 
                background: linear-gradient(135deg, #34495e, #2c3e50);
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            }
            50% { 
                background: linear-gradient(135deg, #5d6d7e, #34495e);
                text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7), 0 0 8px rgba(255, 255, 255, 0.3);
            }
        }

        .chip-drawers {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chip-drawer {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #bdc3c7;
            padding: 8px 4px;
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
            transition: all 0.2s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.9);
        }

        .chip-drawer:last-child {
            border-bottom: none;
        }

        .chip-drawer:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: scale(1.1);
            cursor: pointer;
        }
        
        .chip-drawer:not(.empty):hover {
            background: rgba(52, 152, 219, 0.3);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);
        }
        
        .clickable-denomination {
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .clickable-denomination:hover {
            color: #2980b9;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .chip-drawer.empty {
            background: #f5f5f5;
            color: #999;
            font-style: italic;
        }

        .forme-icon, .forme-icon-composite {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 1.4em;
            font-weight: bold;
            opacity: 1;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            z-index: 5;
        }
        
        .forme-icon-composite {
            display: flex;
            gap: 1px;
        }
        
        .forme-part {
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8));
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .formes-legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .formes-legend h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            text-align: center;
        }

        .formes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .forme-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8em;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .forme-item:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .forme-item.selected {
            background: #2196f3;
            color: white;
            border-color: #1976d2;
        }
        
        .forme-legend-icon {
            font-size: 2em;
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
        }
        
        .forme-legend-simple {
            font-size: 1.5em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8));
        }
        
        .forme-legend-composite {
            display: flex;
            gap: 2px;
            align-items: center;
            justify-content: center;
        }
        
        .forme-legend-part {
            font-size: 1.3em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8));
        }
        
        .forme-legend-text {
            font-size: 0.9em;
            text-align: center;
            word-break: break-word;
        }

        /* Couleurs des icônes de formes seulement */
        .forme-icon.carre { color: #3498db; } /* Bleu */
        .forme-icon.triangle { color: #27ae60; } /* Vert */
        .forme-icon.cercle { color: #f1c40f; } /* Jaune */
        .forme-icon.rectangle { color: #e74c3c; } /* Rouge */
        
        /* Styles supprimés - remplacés par la nouvelle approche avec spans colorés */

        /* Panneau latéral pour Granque et Tome */
        .main-content {
            transition: margin-right 0.3s ease;
        }
        
        .side-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: #f0f8ff;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
            transition: right 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
            border: 5px solid red;
            display: block;
        }
        
        .side-panel.open {
            right: 0 !important;
            background: #f0f8ff !important;
            border: 5px solid red !important;
        }
        
        .main-content.panel-open {
            margin-right: 380px;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-header h3 {
            margin: 0;
        }
        
        .panel-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .panel-section {
            padding: 20px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .panel-section h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }
        
        .granque-buttons, .tome-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .granque-btn, .tome-btn {
            padding: 10px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            color: #3498db;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            /* Debug temporaire */
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .granque-btn:hover, .tome-btn:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }
        
        .tome-btn {
            border-color: #9b59b6;
            color: #9b59b6;
        }
        
        .tome-btn:hover {
            background: #9b59b6;
            color: white;
        }
        
        .open-panel-btn {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        .open-panel-btn:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .redundant-values {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .redundant-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .redundant-item:hover {
            background: #ffeaa7;
            transform: translateX(5px);
        }
        
        .redundant-count {
            font-weight: bold;
            color: #d63031;
        }
        
        /* Mise en évidence des éléments tome */
        .tome-highlight {
            position: relative;
            animation: tomeGlow 2s infinite;
        }
        
        .tome-highlight::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 3px solid #9b59b6;
            border-radius: 10px;
            animation: tomePulse 1.5s infinite;
            pointer-events: none;
        }
        
        @keyframes tomeGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(155, 89, 182, 0.5); }
            50% { box-shadow: 0 0 20px rgba(155, 89, 182, 0.8); }
        }
        
        @keyframes tomePulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }
        
        /* Styles pour le filtrage */
        .chip-cell.filtered-out {
            opacity: 0.2;
            filter: grayscale(100%);
            transform: scale(0.95);
            transition: all 0.3s ease;
        }
        
        .chip-cell.filtered-in {
            opacity: 1;
            filter: none;
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
            border: 2px solid #3498db;
            transition: all 0.3s ease;
        }
        
        .granque-btn.active, .tome-btn.active {
            background: #3498db !important;
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
        
        .tome-btn.active {
            background: #9b59b6 !important;
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4);
        }

        /* === STYLES DE FILTRAGE AVEC STRUCTURE PRÉSERVÉE === */
        
        /* Filtre TOME - Chips visibles/invisibles */
        .chip-cell.tome-visible {
            background: linear-gradient(135deg, #27ae60, #2ecc71) !important;
            border: 4px solid #27ae60 !important;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.6) !important;
            transform: scale(1.02) !important;
            z-index: 10 !important;
            opacity: 1 !important;
        }
        
        .chip-cell.tome-hidden {
            opacity: 0.05 !important;
            background: transparent !important;
            border: 1px dashed #ecf0f1 !important;
            box-shadow: none !important;
            transform: none !important;
            pointer-events: none !important;
        }
        
        /* Filtre GRANQUE - Dénominations visibles/invisibles */
        .chip-drawer.granque-visible {
            background: linear-gradient(135deg, #3498db, #5dade2) !important;
            border: 3px solid #2980b9 !important;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.6) !important;
            color: white !important;
            font-weight: bold !important;
            opacity: 1 !important;
        }
        
        .chip-drawer.granque-hidden {
            opacity: 0 !important;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: transparent !important;
            pointer-events: none !important;
        }
        
        /* Chips avec dénominations invisibles - style fantôme */
        .chip-cell.chip-empty {
            opacity: 0.05 !important;
            background: transparent !important;
            border: 1px dashed #ecf0f1 !important;
            box-shadow: none !important;
            pointer-events: none !important;
        }
        
        .chip-cell.chip-empty .chip-header {
            opacity: 0.3 !important;
            color: #bdc3c7 !important;
        }
        
        /* Animation de transition */
        .chip-cell, .chip-drawer {
            transition: all 0.3s ease !important;
        }
        
        .filter-info {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #2c3e50;
        }
        
        .clear-filters-btn {
            width: 100%;
            padding: 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .clear-filters-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .katula-grid {
                grid-template-columns: auto repeat(3, 1fr);
                gap: 2px;
                padding: 10px;
            }
            
            .chip-cell {
                min-height: 80px;
            }
            
            .chip-drawer {
                font-size: 0.7em;
                padding: 4px 2px;
            }
            
            .side-panel {
                width: 100%;
                right: -100%;
            }
            
            .main-content.panel-open {
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="header-container"></div>
    <script>
    // Injecter le header universel au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof UniversalHeader !== 'undefined') {
            UniversalHeader.injectHeader('header-container', 'katula-dynamic', {
                showNavigation: true,
                showUserInfo: false
            });
        }
    });
    </script>

        <div class="controls">
            <select id="universeSelect">
                <option value="">Sélectionner un univers</option>
                <option value="mundo">🌍 Mundo</option>
                <option value="fruity">🍎 Fruity</option>
                <option value="trigga">⚡ Trigga</option>
                <option value="roaster">☕ Roaster</option>
                <option value="sunshine">☀️ Sunshine</option>
            </select>
            <button onclick="loadUniverse()" id="loadBtn">🔄 Charger Univers</button>
            <button onclick="highlightForme()" id="highlightBtn" disabled>🎨 Surligner Forme</button>
            <button onclick="resetHighlight()" id="resetBtn" disabled>🔄 Reset</button>
        </div>

        <div id="universeInfo" class="universe-info" style="display: none;"></div>
        <div id="formesLegend" class="formes-legend" style="display: none;"></div>
        
        <div class="quadrant-selector" id="quadrantSelector" style="display: none;">
            <button class="quadrant-btn q1" onclick="selectQuadrant('q1')">q1 (1-21)</button>
            <button class="quadrant-btn q2" onclick="selectQuadrant('q2')">q2 (4-24)</button>
            <button class="quadrant-btn q3" onclick="selectQuadrant('q3')">q3 (25-45)</button>
            <button class="quadrant-btn q4" onclick="selectQuadrant('q4')">q4 (28-48)</button>
            <button class="quadrant-btn btn-all" onclick="showAllTableDetails()" style="border-color: #95a5a6; color: #95a5a6;" title="Cliquer pour voir toutes les dénominations de la table complète">TOUT</button>
        </div>
        
        <div class="main-content">
            <div id="katulaContainer"></div>
            <div id="loadingIndicator" class="loading" style="display: none;">
                🔄 Chargement des données depuis la base de données...
            </div>
        </div>
        
        <!-- Panneau latéral pour Granque et Tome -->
        <div id="sidePanel" class="side-panel" style="display: none;">
            <div class="panel-header">
                <h3>Analyse Avancée</h3>
                <button onclick="toggleSidePanel()" class="panel-toggle">×</button>
            </div>
            
            <div class="panel-section">
                <h4>🏛️ GRANQUES (BD)</h4>
                <div id="granqueButtons" class="granque-buttons"></div>
                <div class="filter-info" id="granqueFilterInfo" style="display: none;"></div>
            </div>
            
            <div class="panel-section">
                <h4>📚 TOMES</h4>
                <div id="tomeButtons" class="tome-buttons"></div>
                <div class="filter-info" id="tomeFilterInfo" style="display: none;"></div>
            </div>
            
            <div class="panel-section">
                <h4>🔍 Valeurs Redondantes</h4>
                <div id="redundantValues" class="redundant-values"></div>
            </div>
            
            <div class="panel-section">
                <h4>🎛️ Contrôles</h4>
                <button onclick="clearAllFilters()" class="clear-filters-btn">🔄 Effacer tous les filtres</button>
            </div>
        </div>
        
        <!-- Bouton pour ouvrir le panneau -->
        <button id="openPanelBtn" class="open-panel-btn" onclick="toggleSidePanel()" style="display: none;">
            📊 Analyse
        </button>
    </div>

    <script>
        const API_BASE = 'http://localhost:8081/api/analytics';
        let currentUniverse = null;
        let universeData = null;
        let selectedForme = null;

        // Icônes pour les formes avec couleurs
        const FORME_ICONS = {
            'carre': '■',        // Bleu
            'triangle': '▲',     // Vert
            'cercle': '●',       // Jaune
            'rectangle': '▬',    // Rouge
            'carre-triangle': '■▲',
            'carre-cercle': '■●',
            'carre-rectangle': '■▬',
            'triangle-carre': '▲■',
            'triangle-cercle': '▲●',
            'triangle-rectangle': '▲▬',
            'cercle-carre': '●■',
            'cercle-triangle': '●▲',
            'cercle-rectangle': '●▬',
            'rectangle-carre': '▬■',
            'rectangle-triangle': '▬▲',
            'rectangle-cercle': '▬●'
        };

        // Couleurs des formes de base
        const FORME_COLORS = {
            'carre': '#3498db',      // Bleu
            'triangle': '#27ae60',   // Vert
            'cercle': '#f1c40f',     // Jaune
            'rectangle': '#e74c3c'   // Rouge
        };

        function generateFormeIcon(forme) {
            if (forme.includes('-')) {
                // Forme composée - créer deux spans colorés
                const [forme1, forme2] = forme.split('-');
                const icon1 = FORME_ICONS[forme1] || '?';
                const icon2 = FORME_ICONS[forme2] || '?';
                const color1 = FORME_COLORS[forme1] || '#666';
                const color2 = FORME_COLORS[forme2] || '#666';
                
                return `
                    <span class="forme-icon-composite">
                        <span class="forme-part" style="color: ${color1}">${icon1}</span><span class="forme-part" style="color: ${color2}">${icon2}</span>
                    </span>
                `;
            } else {
                // Forme simple
                const icon = FORME_ICONS[forme] || '?';
                const color = FORME_COLORS[forme] || '#666';
                
                return `<span class="forme-icon" style="color: ${color}">${icon}</span>`;
            }
        }

        function generateFormeLegendIcon(forme) {
            if (forme.includes('-')) {
                // Forme composée - créer deux spans colorés pour la légende
                const [forme1, forme2] = forme.split('-');
                const icon1 = FORME_ICONS[forme1] || '?';
                const icon2 = FORME_ICONS[forme2] || '?';
                const color1 = FORME_COLORS[forme1] || '#666';
                const color2 = FORME_COLORS[forme2] || '#666';
                
                return `
                    <div class="forme-legend-composite">
                        <span class="forme-legend-part" style="color: ${color1}">${icon1}</span>
                        <span class="forme-legend-part" style="color: ${color2}">${icon2}</span>
                    </div>
                `;
            } else {
                // Forme simple
                const icon = FORME_ICONS[forme] || '?';
                const color = FORME_COLORS[forme] || '#666';
                
                return `<span class="forme-legend-simple" style="color: ${color}">${icon}</span>`;
            }
        }

        // Fonctions pour gérer les clics sur les en-têtes et quadrants
        function showColumnDetails(columnNumber) {
            console.log(`Affichage des détails de la colonne C${columnNumber}`);
            
            // Récupérer toutes les dénominations de cette colonne
            const columnDenominations = [];
            
            for (let ligne = 1; ligne <= 8; ligne++) {
                const chipNumber = ((ligne - 1) * 6) + columnNumber;
                const chipData = universeData.chipDetails[chipNumber];
                
                if (chipData && chipData.formes_data) {
                    Object.entries(chipData.formes_data).forEach(([forme, items]) => {
                        items.forEach(item => {
                            if (item.denomination && !columnDenominations.includes(item.denomination)) {
                                columnDenominations.push(item.denomination);
                            }
                        });
                    });
                }
            }
            
            if (columnDenominations.length > 0) {
                const searchString = columnDenominations.join('/');
                const contextualTitle = `COLONNE C${columnNumber} - ${currentUniverse.toUpperCase()}`;
                showDenominationDetailsWithContext(searchString, currentUniverse, contextualTitle, `Toutes les dénominations de la colonne C${columnNumber}`);
            } else {
                alert(`Aucune dénomination trouvée dans la colonne C${columnNumber}`);
            }
        }
        
        function showRowDetails(rowNumber) {
            console.log(`Affichage des détails de la ligne L${rowNumber}`);
            
            // Récupérer toutes les dénominations de cette ligne
            const rowDenominations = [];
            
            for (let col = 1; col <= 6; col++) {
                const chipNumber = ((rowNumber - 1) * 6) + col;
                const chipData = universeData.chipDetails[chipNumber];
                
                if (chipData && chipData.formes_data) {
                    Object.entries(chipData.formes_data).forEach(([forme, items]) => {
                        items.forEach(item => {
                            if (item.denomination && !rowDenominations.includes(item.denomination)) {
                                rowDenominations.push(item.denomination);
                            }
                        });
                    });
                }
            }
            
            if (rowDenominations.length > 0) {
                const searchString = rowDenominations.join('/');
                const contextualTitle = `LIGNE L${rowNumber} - ${currentUniverse.toUpperCase()}`;
                showDenominationDetailsWithContext(searchString, currentUniverse, contextualTitle, `Toutes les dénominations de la ligne L${rowNumber}`);
            } else {
                alert(`Aucune dénomination trouvée dans la ligne L${rowNumber}`);
            }
        }
        
        function showQuadrantDetails(quadrant) {
            console.log(`Affichage des détails du quadrant ${quadrant}`);
            
            // Définir les plages de chips pour chaque quadrant
            const quadrantRanges = {
                'q1': { lignes: [1, 2, 3, 4], colonnes: [1, 2, 3] },
                'q2': { lignes: [1, 2, 3, 4], colonnes: [4, 5, 6] },
                'q3': { lignes: [5, 6, 7, 8], colonnes: [1, 2, 3] },
                'q4': { lignes: [5, 6, 7, 8], colonnes: [4, 5, 6] }
            };
            
            const range = quadrantRanges[quadrant];
            const quadrantDenominations = [];
            
            range.lignes.forEach(ligne => {
                range.colonnes.forEach(col => {
                    const chipNumber = ((ligne - 1) * 6) + col;
                    const chipData = universeData.chipDetails[chipNumber];
                    
                    if (chipData && chipData.formes_data) {
                        Object.entries(chipData.formes_data).forEach(([forme, items]) => {
                            items.forEach(item => {
                                if (item.denomination && !quadrantDenominations.includes(item.denomination)) {
                                    quadrantDenominations.push(item.denomination);
                                }
                            });
                        });
                    }
                });
            });
            
            if (quadrantDenominations.length > 0) {
                const searchString = quadrantDenominations.join('/');
                const contextualTitle = `QUADRANT ${quadrant.toUpperCase()} - ${currentUniverse.toUpperCase()}`;
                const chipRange = getQuadrantChipRange(quadrant);
                showDenominationDetailsWithContext(searchString, currentUniverse, contextualTitle, `Toutes les dénominations du quadrant ${quadrant.toUpperCase()} (${chipRange})`);
            } else {
                alert(`Aucune dénomination trouvée dans le quadrant ${quadrant.toUpperCase()}`);
            }
        }

        function getQuadrantChipRange(quadrant) {
            const ranges = {
                'q1': 'Chips 1-21',
                'q2': 'Chips 4-24', 
                'q3': 'Chips 25-45',
                'q4': 'Chips 28-48'
            };
            return ranges[quadrant] || 'Chips inconnus';
        }

        async function showDenominationDetailsWithContext(denomination, universe, contextTitle, contextDescription) {
            try {
                console.log(`Récupération des détails pour: ${denomination} dans ${universe}`);
                
                // Gérer les dénominations multiples séparées par "/"
                const denominations = denomination.split('/').map(d => d.trim());
                let allCombinations = [];
                
                for (const singleDenomination of denominations) {
                    console.log('Recherche:', singleDenomination);
                    
                    const url = `${API_BASE}/denomination/${universe}/${encodeURIComponent(singleDenomination)}`;
                    console.log('URL:', url);
                    
                    const response = await fetch(url);
                    console.log('Status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Données reçues:', data);
                        if (data.details && data.details.length > 0) {
                            allCombinations.push(...data.details);
                        }
                    } else {
                        const errorText = await response.text();
                        console.warn(`Aucune donnée pour "${singleDenomination}": ${response.status} - ${errorText}`);
                    }
                }
                
                if (allCombinations.length === 0) {
                    alert(`Aucune combinaison trouvée pour "${denomination}" dans ${universe}`);
                    return;
                }
                
                // Trier les combinaisons par dénomination puis par position alphabétique
                allCombinations.sort((a, b) => {
                    // D'abord par dénomination
                    if (a.denomination !== b.denomination) {
                        return a.denomination.localeCompare(b.denomination);
                    }
                    // Puis par position alphabétique (alpha_ranking)
                    const posA = a.alpha_ranking || 'z';
                    const posB = b.alpha_ranking || 'z';
                    return posA.localeCompare(posB);
                });
                
                // Créer la structure de données pour la modale avec contexte
                const combinedData = {
                    denomination: contextTitle,  // Utiliser le titre contextuel
                    universe: universe,
                    total_occurrences: allCombinations.length,
                    details: allCombinations,
                    contextDescription: contextDescription  // Ajouter la description
                };
                
                displayDenominationModalWithContext(combinedData);
                
            } catch (error) {
                console.error('Erreur récupération dénomination:', error);
                alert(`Erreur lors de la récupération des détails de "${denomination}": ${error.message}`);
            }
        }

        function displayDenominationModalWithContext(data) {
            const { universe, denomination, total_occurrences, details, contextDescription } = data;
            
            // Vérifier si c'est une recherche multiple (avec "/")
            const isMultipleSearch = denomination.includes('/') || details.some(d => d.denomination !== details[0].denomination);
            
            // Créer une modale HTML interactive avec contexte
            const modalHTML = `
                <div id="denominationModal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>${denomination}</h2>
                            <span class="modal-close" onclick="closeDenominationModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="modal-context">
                                <div class="context-description">${contextDescription || ''}</div>
                            </div>
                            <div class="modal-info">
                                <span class="info-badge universe">UNIVERS: ${universe.toUpperCase()}</span>
                                <span class="info-badge count">OCCURRENCES: ${total_occurrences}</span>
                            </div>
                            <div class="combinations-container">
                                ${generateCombinationsHTML(details, isMultipleSearch)}
                            </div>
                            <div class="modal-actions">
                                <button onclick="showAllCombinations()" class="btn-show-all">Afficher Tout</button>
                                <button onclick="exportCombinations()" class="btn-export">Exporter</button>
                                <button onclick="closeDenominationModal()" class="btn-close">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ajouter la modale au DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Stocker les données pour utilisation ultérieure
            window.currentDenominationData = data;
        }

        function showAllTableDetails() {
            console.log('Affichage des détails de toute la table');
            
            // Récupérer toutes les dénominations de tous les chips (1-48)
            const allDenominations = [];
            
            for (let chipNumber = 1; chipNumber <= 48; chipNumber++) {
                const chipData = universeData.chipDetails[chipNumber];
                
                if (chipData && chipData.formes_data) {
                    Object.entries(chipData.formes_data).forEach(([forme, items]) => {
                        items.forEach(item => {
                            if (item.denomination && !allDenominations.includes(item.denomination)) {
                                allDenominations.push(item.denomination);
                            }
                        });
                    });
                }
            }
            
            if (allDenominations.length > 0) {
                const searchString = allDenominations.join('/');
                const contextualTitle = `TABLE COMPLÈTE - ${currentUniverse.toUpperCase()}`;
                showDenominationDetailsWithContext(searchString, currentUniverse, contextualTitle, `Toutes les dénominations de la table complète (48 chips)`);
            } else {
                alert('Aucune dénomination trouvée dans la table');
            }
        }

        function showGranqueDetails(granque) {
            console.log(`Affichage des détails du granque ${granque}`);
            
            // Les granques sont des zones plus larges que les petiques
            // Définir les plages de chips pour chaque granque (plus large que petique)
            const granqueRanges = {
                'Q1': { lignes: [1, 2, 3, 4], colonnes: [1, 2, 3] },      // Même zone que q1 mais concept différent
                'Q2': { lignes: [1, 2, 3, 4], colonnes: [4, 5, 6] },      // Même zone que q2 mais concept différent
                'Q3': { lignes: [5, 6, 7, 8], colonnes: [1, 2, 3] },      // Même zone que q3 mais concept différent
                'Q4': { lignes: [5, 6, 7, 8], colonnes: [4, 5, 6] }       // Même zone que q4 mais concept différent
            };
            
            const range = granqueRanges[granque];
            const granqueDenominations = [];
            
            range.lignes.forEach(ligne => {
                range.colonnes.forEach(col => {
                    const chipNumber = ((ligne - 1) * 6) + col;
                    const chipData = universeData.chipDetails[chipNumber];
                    
                    if (chipData && chipData.formes_data) {
                        Object.entries(chipData.formes_data).forEach(([forme, items]) => {
                            items.forEach(item => {
                                if (item.denomination && !granqueDenominations.includes(item.denomination)) {
                                    granqueDenominations.push(item.denomination);
                                }
                            });
                        });
                    }
                });
            });
            
            if (granqueDenominations.length > 0) {
                const searchString = granqueDenominations.join('/');
                const contextualTitle = `GRANQUE ${granque} - ${currentUniverse.toUpperCase()}`;
                const chipRange = getGranqueChipRange(granque);
                showDenominationDetailsWithContext(searchString, currentUniverse, contextualTitle, `Toutes les dénominations du granque ${granque} (${chipRange})`);
            } else {
                alert(`Aucune dénomination trouvée dans le granque ${granque}`);
            }
        }

        function getGranqueChipRange(granque) {
            const ranges = {
                'Q1': 'Chips 1-21 (Granque)',
                'Q2': 'Chips 4-24 (Granque)', 
                'Q3': 'Chips 25-45 (Granque)',
                'Q4': 'Chips 28-48 (Granque)'
            };
            return ranges[granque] || 'Chips inconnus';
        }

        // Variables pour le panneau latéral
        let sidePanelOpen = false;
        let currentTomeHighlight = null;
        let currentGranqueFilter = null;
        let currentTomeFilter = null;
        let granqueChipMapping = {};
        let tomeChipMapping = {};

        function toggleSidePanel() {
            console.log('Toggle side panel appelé');
            
            const panel = document.getElementById('sidePanel');
            const mainContent = document.querySelector('.main-content');
            const openBtn = document.getElementById('openPanelBtn');
            
            if (!panel) {
                console.error('Panneau latéral non trouvé');
                return;
            }
            
            console.log('Panel element:', panel);
            console.log('Panel style avant:', panel.style.cssText);
            console.log('Panel classes avant:', panel.className);
            
            sidePanelOpen = !sidePanelOpen;
            console.log('Panneau ouvert:', sidePanelOpen);
            
            if (sidePanelOpen) {
                panel.classList.add('open');
                // Force le style directement pour debug
                panel.style.right = '0px';
                panel.style.display = 'block';
                panel.style.visibility = 'visible';
                
                if (mainContent) mainContent.classList.add('panel-open');
                if (openBtn) openBtn.style.display = 'none';
            } else {
                panel.classList.remove('open');
                panel.style.right = '-400px';
                
                if (mainContent) mainContent.classList.remove('panel-open');
                if (openBtn) openBtn.style.display = 'block';
            }
            
            console.log('Panel style après:', panel.style.cssText);
            console.log('Panel classes après:', panel.className);
        }

        async function loadGranqueAndTomeData() {
            if (!universeData) {
                console.log('Pas de données univers disponibles');
                return;
            }
            
            console.log('Chargement des données Granque et Tome depuis la BD...');
            
            try {
                // Récupérer les vraies données depuis la BD
                const response = await fetch(`${API_BASE}/granque-tome/${currentUniverse}`);
                
                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Données BD reçues:', data);
                
                const granqueData = data.granque_data || {};
                const tomeData = data.tome_data || {};
                
                // Calculer les redondances depuis les données existantes
                const redundantData = {};
                
                // Analyser toutes les dénominations pour détecter les redondances
                for (let chipNumber = 1; chipNumber <= 48; chipNumber++) {
                    const chipData = universeData.chipDetails[chipNumber];
                    
                    if (chipData && chipData.formes_data) {
                        Object.entries(chipData.formes_data).forEach(([forme, items]) => {
                            items.forEach(item => {
                                const key = item.denomination;
                                if (!redundantData[key]) redundantData[key] = [];
                                redundantData[key].push({
                                    chip: chipNumber,
                                    forme: forme
                                });
                            });
                        });
                    }
                }
            
                console.log('Données granque BD:', granqueData);
                console.log('Données tome BD:', tomeData);
                console.log('Données redondantes:', redundantData);
                
                // Afficher les boutons granque (utilise universeData.granqueTome)
                displayGranqueButtons(granqueData);
                
                // Afficher les boutons tome
                displayTomeButtons(tomeData);
                
                // Afficher les valeurs redondantes
                displayRedundantValues(redundantData);
                
            } catch (error) {
                console.error('Erreur lors du chargement des données granque/tome:', error);
                
                // Fallback avec message d'erreur
                document.getElementById('granqueButtons').innerHTML = 
                    '<div style="color: red; text-align: center; padding: 20px;">Erreur de chargement des données granque</div>';
                document.getElementById('tomeButtons').innerHTML = 
                    '<div style="color: red; text-align: center; padding: 20px;">Erreur de chargement des données tome</div>';
            }
        }

        function displayGranqueButtons(granqueData) {
            console.log('displayGranqueButtons appelé avec:', granqueData);
            const container = document.getElementById('granqueButtons');
            
            if (!container) {
                console.error('Container granqueButtons non trouvé');
                return;
            }
            
            let html = '';
            
            Object.keys(granqueData).sort().forEach(granque => {
                const count = granqueData[granque].length;
                html += `
                    <div class="granque-btn" onclick="showGranqueFromDB('${granque}')" title="${count} éléments">
                        ${granque}
                        <div style="font-size: 0.8em;">(${count})</div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">Aucune donnée granque disponible</div>';
            }
            
            console.log('HTML granque généré:', html);
            container.innerHTML = html;
            console.log('Container granque après insertion:', container.innerHTML.length, 'caractères');
        }

        function displayTomeButtons(tomeData) {
            console.log('displayTomeButtons appelé avec:', tomeData);
            const container = document.getElementById('tomeButtons');
            
            if (!container) {
                console.error('Container tomeButtons non trouvé');
                return;
            }
            
            let html = '';
            
            Object.keys(tomeData).sort().forEach(tome => {
                const count = tomeData[tome].length;
                html += `
                    <div class="tome-btn" onclick="highlightTome('${tome}')" title="${count} éléments">
                        ${tome}
                        <div style="font-size: 0.8em;">(${count})</div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">Aucune donnée tome disponible</div>';
            }
            
            console.log('HTML tome généré:', html);
            container.innerHTML = html;
            console.log('Container tome après insertion:', container.innerHTML.length, 'caractères');
        }

        function displayRedundantValues(redundantData) {
            const container = document.getElementById('redundantValues');
            let html = '';
            
            // Filtrer seulement les valeurs qui apparaissent plus d'une fois
            Object.entries(redundantData).forEach(([denomination, occurrences]) => {
                if (occurrences.length > 1) {
                    html += `
                        <div class="redundant-item" onclick="showRedundantDetails('${denomination}')">
                            <div><strong>${denomination}</strong></div>
                            <div class="redundant-count">${occurrences.length} occurrences</div>
                            <div style="font-size: 0.8em; color: #666;">
                                Chips: ${occurrences.map(o => o.chip).join(', ')}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (html === '') {
                html = '<div style="color: #666; font-style: italic;">Aucune redondance détectée</div>';
            }
            
            container.innerHTML = html;
        }

        function showGranqueFromDB(granque) {
            console.log(`Filtrage par granque ${granque}`);
            
            // Désactiver le filtre tome si actif
            if (currentTomeFilter) {
                clearTomeFilter();
            }
            
            // Toggle du filtre granque
            if (currentGranqueFilter === granque) {
                clearGranqueFilter();
                return;
            }
            
            currentGranqueFilter = granque;
            
            // Mettre à jour l'état des boutons
            document.querySelectorAll('.granque-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="showGranqueFromDB('${granque}')"]`).classList.add('active');
            
            // Filtrer les chips
            filterChipsByGranque(granque);
            
            // Afficher les informations du filtre
            showGranqueFilterInfo(granque);
        }
        
        function filterChipsByGranque(granque) {
            if (!universeData || !universeData.granqueTome) {
                console.error('Données granque/tome non disponibles');
                return;
            }
            
            const granqueData = universeData.granqueTome.granque_data;
            const granqueItems = granqueData[granque] || [];
            const granqueDenominations = granqueItems.map(item => item.denomination);
            
            console.log(`Dénominations du granque ${granque}:`, granqueDenominations);
            
            // Filtrer toutes les dénominations - VISIBILITÉ avec structure préservée
            document.querySelectorAll('.chip-drawer').forEach(drawer => {
                const denomination = drawer.getAttribute('data-denomination');
                
                if (granqueDenominations.includes(denomination)) {
                    // Dénomination appartient au granque → VISIBLE avec surbrillance bleue
                    drawer.classList.remove('granque-hidden');
                    drawer.classList.add('granque-visible');
                } else {
                    // Dénomination n'appartient pas au granque → INVISIBLE mais garde sa place
                    drawer.classList.remove('granque-visible');
                    drawer.classList.add('granque-hidden');
                }
            });
            
            // Styliser les chips qui n'ont aucune dénomination visible
            document.querySelectorAll('.chip-cell').forEach(chip => {
                const visibleDrawers = chip.querySelectorAll('.chip-drawer.granque-visible');
                if (visibleDrawers.length === 0) {
                    // Aucune dénomination visible → chip en mode fantôme
                    chip.classList.add('chip-empty');
                } else {
                    // Au moins une dénomination visible → chip normal
                    chip.classList.remove('chip-empty');
                }
            });
        }
        
        function showGranqueFilterInfo(granque) {
            const infoDiv = document.getElementById('granqueFilterInfo');
            
            if (!universeData || !universeData.granqueTome) {
                infoDiv.innerHTML = '<span style="color: red;">Données non disponibles</span>';
                infoDiv.style.display = 'block';
                return;
            }
            
            const granqueData = universeData.granqueTome.granque_data;
            const granqueItems = granqueData[granque] || [];
            const granqueDenominations = granqueItems.map(item => item.denomination);
            
            infoDiv.innerHTML = `
                <strong>Filtre actif: ${granque}</strong><br>
                ${granqueDenominations.length} dénominations affichées<br>
                Dénominations: ${granqueDenominations.slice(0, 5).join(', ')}${granqueDenominations.length > 5 ? '...' : ''}
            `;
            infoDiv.style.display = 'block';
        }
        
        function clearGranqueFilter() {
            currentGranqueFilter = null;
            
            // Désactiver tous les boutons granque
            document.querySelectorAll('.granque-btn').forEach(btn => btn.classList.remove('active'));
            
            // Restaurer tous les chips (supprimer styles granque)
            document.querySelectorAll('.chip-cell').forEach(chip => {
                chip.classList.remove('filtered-out', 'filtered-in', 'chip-empty');
            });
            
            // Restaurer toutes les dénominations
            document.querySelectorAll('.chip-drawer').forEach(drawer => {
                drawer.classList.remove('granque-visible', 'granque-hidden');
            });
            
            // Cacher les informations du filtre
            document.getElementById('granqueFilterInfo').style.display = 'none';
        }

        function highlightTome(tome) {
            console.log(`Filtrage par tome: ${tome}`);
            
            // Désactiver le filtre granque si actif
            if (currentGranqueFilter) {
                clearGranqueFilter();
            }
            
            // Toggle du filtre tome
            if (currentTomeFilter === tome) {
                clearTomeFilter();
                return;
            }
            
            currentTomeFilter = tome;
            
            // Mettre à jour l'état des boutons
            document.querySelectorAll('.tome-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="highlightTome('${tome}')"]`).classList.add('active');
            
            // Filtrer les chips par tome
            filterChipsByTome(tome);
            
            // Afficher les informations du filtre
            showTomeFilterInfo(tome);
        }
        
        function filterChipsByTome(tome) {
            if (!universeData || !universeData.granqueTome) {
                console.error('Données granque/tome non disponibles');
                return;
            }
            
            const tomeData = universeData.granqueTome.tome_data;
            const tomeItems = tomeData[tome] || [];
            
            // Extraire les numéros de chip depuis les données BD
            const tomeChipNumbers = new Set();
            tomeItems.forEach(item => {
                if (item.chip) {
                    tomeChipNumbers.add(item.chip);
                }
            });
            
            console.log(`Chips du tome ${tome}:`, Array.from(tomeChipNumbers));
            
            // Filtrer tous les chips - VISIBILITÉ avec structure préservée
            for (let chipNumber = 1; chipNumber <= 48; chipNumber++) {
                const chipElement = document.querySelector(`[data-chip="${chipNumber}"]`);
                
                if (chipElement) {
                    if (tomeChipNumbers.has(chipNumber)) {
                        // Chip appartient au tome → VISIBLE avec surbrillance verte
                        chipElement.classList.remove('tome-hidden');
                        chipElement.classList.add('tome-visible');
                    } else {
                        // Chip n'appartient pas au tome → INVISIBLE mais garde sa place
                        chipElement.classList.remove('tome-visible');
                        chipElement.classList.add('tome-hidden');
                    }
                }
            }
        }
        
        function getChipNumberFromPosition(position) {
            // Convertir position "L1C1" en numéro de chip (1-48)
            const match = position.match(/L(\d+)C(\d+)/);
            if (match) {
                const ligne = parseInt(match[1]);
                const colonne = parseInt(match[2]);
                return (ligne - 1) * 6 + colonne;
            }
            return null;
        }

        function showTomeFilterInfo(tome) {
            const infoDiv = document.getElementById('tomeFilterInfo');
            
            if (!universeData || !universeData.granqueTome) {
                infoDiv.innerHTML = '<span style="color: red;">Données non disponibles</span>';
                infoDiv.style.display = 'block';
                return;
            }
            
            const tomeData = universeData.granqueTome.tome_data;
            const tomeItems = tomeData[tome] || [];
            const tomeDenominations = tomeItems.map(item => item.denomination);
            const tomeChips = [...new Set(tomeItems.map(item => item.chip))];
            
            infoDiv.innerHTML = `
                <strong>Filtre actif: ${tome}</strong><br>
                ${tomeChips.length} chips affichés<br>
                ${tomeDenominations.length} dénominations<br>
                Chips: ${tomeChips.join(', ')}
            `;
            infoDiv.style.display = 'block';
        }
        
        function clearTomeFilter() {
            currentTomeFilter = null;
            
            // Désactiver tous les boutons tome
            document.querySelectorAll('.tome-btn').forEach(btn => btn.classList.remove('active'));
            
            // Restaurer tous les chips (supprimer styles tome)
            document.querySelectorAll('.chip-cell').forEach(chip => {
                chip.classList.remove('filtered-out', 'filtered-in', 'tome-visible', 'tome-hidden');
            });
            
            // Cacher les informations du filtre
            document.getElementById('tomeFilterInfo').style.display = 'none';
        }

        function showRedundantDetails(denomination) {
            showDenominationDetails(denomination, currentUniverse, { stopPropagation: () => {} });
        }
        
        function clearAllFilters() {
            console.log('Effacement de tous les filtres');
            
            clearGranqueFilter();
            clearTomeFilter();
            
            // Nettoyage complet de tous les styles de filtrage
            document.querySelectorAll('.chip-cell').forEach(chip => {
                chip.classList.remove('tome-visible', 'tome-hidden', 'chip-empty', 'filtered-out', 'filtered-in');
            });
            
            document.querySelectorAll('.chip-drawer').forEach(drawer => {
                drawer.classList.remove('granque-visible', 'granque-hidden', 'filtered-out', 'filtered-in');
            });
        }

        async function loadUniverse() {
            const universeSelect = document.getElementById('universeSelect');
            const selectedUniverse = universeSelect.value;
            
            if (!selectedUniverse) {
                alert('Veuillez sélectionner un univers');
                return;
            }

            const loadBtn = document.getElementById('loadBtn');
            loadBtn.disabled = true;
            loadBtn.textContent = '🔄 Chargement...';
            
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('katulaContainer').innerHTML = '';
            
            try {
                currentUniverse = selectedUniverse;
                
                // Charger les données de l'univers
                await loadUniverseData(selectedUniverse);
                
                // Afficher l'interface
                displayKatulaTable();
                displayUniverseInfo();
                displayFormesLegend();
                
                // Activer les boutons
                document.getElementById('highlightBtn').disabled = false;
                document.getElementById('resetBtn').disabled = false;
                
                // Charger les données du panneau latéral
                await loadGranqueAndTomeData();
                
                // Afficher le bouton d'ouverture du panneau
                document.getElementById('openPanelBtn').style.display = 'block';
                
                showSuccess(`Univers ${selectedUniverse} chargé avec succès!`);
                
            } catch (error) {
                showError('Erreur lors du chargement: ' + error.message);
                console.error('Erreur:', error);
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = '🔄 Charger Univers';
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        async function loadUniverseData(universe) {
            try {
                console.log(`Chargement de ${universe}...`);
                
                // Charger la table de Katula avec les positions des chips
                const tableResponse = await fetch(`${API_BASE}/katula/table/${universe}`);
                if (!tableResponse.ok) {
                    throw new Error(`Erreur table ${universe}: ${tableResponse.status}`);
                }
                const tableData = await tableResponse.json();
                
                // Charger les formes spécifiques à cet univers
                const formesResponse = await fetch(`${API_BASE}/katula/formes/${universe}`);
                let formesData = { formes: ['carre', 'triangle', 'cercle', 'rectangle'] };
                if (formesResponse.ok) {
                    formesData = await formesResponse.json();
                }
                
                // Charger les données détaillées pour chaque chip (1-48) depuis la BD
                const chipDetails = {};
                for (let chipNum = 1; chipNum <= 48; chipNum++) {
                    try {
                        // Utiliser l'endpoint correct pour récupérer les vraies données
                        const chipResponse = await fetch(`${API_BASE}/katula/chip/${universe}/${chipNum}`);
                        if (chipResponse.ok) {
                            const chipData = await chipResponse.json();
                            chipDetails[chipNum] = chipData;
                            console.log(`Chip ${chipNum} chargé:`, chipData);
                            
                            // Debug spécifique pour les formes_data
                            if (chipData.formes_data) {
                                Object.entries(chipData.formes_data).forEach(([forme, items]) => {
                                    if (items.length > 0) {
                                        console.log(`  ${forme}: ${items.length} items`, items);
                                    }
                                });
                            }
                        } else {
                            console.warn(`Chip ${chipNum} non trouvé, status: ${chipResponse.status}`);
                            chipDetails[chipNum] = { formes_data: {} };
                        }
                    } catch (e) {
                        console.warn(`Erreur chip ${chipNum}:`, e);
                        chipDetails[chipNum] = { formes_data: {} };
                    }
                }
                
                // Charger les données granque et tome depuis la BD
                const granqueTomeResponse = await fetch(`${API_BASE}/granque-tome/${universe}`);
                let granqueTomeData = { granque_data: {}, tome_data: {}, denomination_mapping: {} };
                if (granqueTomeResponse.ok) {
                    granqueTomeData = await granqueTomeResponse.json();
                    console.log('Données granque/tome chargées:', granqueTomeData);
                }
                
                universeData = {
                    table: tableData,
                    formes: formesData,
                    chipDetails: chipDetails,
                    granqueTome: granqueTomeData,
                    universe: universe
                };
                
                console.log(`${universe} chargé avec succès:`, universeData);
                
            } catch (error) {
                console.error(`Erreur chargement ${universe}:`, error);
                throw error;
            }
        }   
     function displayKatulaTable() {
            if (!universeData || !universeData.table) {
                document.getElementById('katulaContainer').innerHTML = '<div class="error">Données de table non disponibles</div>';
                return;
            }

            let html = '<div class="katula-grid">';
            
            // Les lignes de séparation rouges sont créées avec ::before et ::after
            
            // Labels des petiques (q minuscule) - cliquables
            html += '<div class="quadrant-label quadrant-q1 clickable-quadrant petique-label" onclick="showQuadrantDetails(\'q1\')" title="Petique q1 - Cliquer pour voir toutes les dénominations">q1</div>';
            html += '<div class="quadrant-label quadrant-q2 clickable-quadrant petique-label" onclick="showQuadrantDetails(\'q2\')" title="Petique q2 - Cliquer pour voir toutes les dénominations">q2</div>';
            html += '<div class="quadrant-label quadrant-q3 clickable-quadrant petique-label" onclick="showQuadrantDetails(\'q3\')" title="Petique q3 - Cliquer pour voir toutes les dénominations">q3</div>';
            html += '<div class="quadrant-label quadrant-q4 clickable-quadrant petique-label" onclick="showQuadrantDetails(\'q4\')" title="Petique q4 - Cliquer pour voir toutes les dénominations">q4</div>';
            
            // Labels des granques (Q majuscule) - plus grands et différents
            html += '<div class="granque-label granque-q1 clickable-granque" onclick="showGranqueDetails(\'Q1\')" title="Granque Q1 - Cliquer pour voir toutes les dénominations">Q1</div>';
            html += '<div class="granque-label granque-q2 clickable-granque" onclick="showGranqueDetails(\'Q2\')" title="Granque Q2 - Cliquer pour voir toutes les dénominations">Q2</div>';
            html += '<div class="granque-label granque-q3 clickable-granque" onclick="showGranqueDetails(\'Q3\')" title="Granque Q3 - Cliquer pour voir toutes les dénominations">Q3</div>';
            html += '<div class="granque-label granque-q4 clickable-granque" onclick="showGranqueDetails(\'Q4\')" title="Granque Q4 - Cliquer pour voir toutes les dénominations">Q4</div>';
            
            // En-têtes
            html += '<div class="grid-header">Lignes</div>';
            for (let col = 1; col <= 6; col++) {
                html += `<div class="grid-header clickable-header" onclick="showColumnDetails(${col})" title="Cliquer pour voir toutes les dénominations de la colonne C${col}">C${col}</div>`;
            }
            
            // Générer les 8 lignes × 6 colonnes = 48 chips
            for (let ligne = 1; ligne <= 8; ligne++) {
                html += `<div class="ligne-label clickable-header" onclick="showRowDetails(${ligne})" title="Cliquer pour voir toutes les dénominations de la ligne L${ligne}">L${ligne}</div>`;
                
                for (let col = 1; col <= 6; col++) {
                    const chipNumber = ((ligne - 1) * 6) + col;
                    html += createChipHTML(chipNumber, ligne, col);
                }
            }
            
            html += '</div>';
            document.getElementById('katulaContainer').innerHTML = html;
            
            // Afficher les sélecteurs de quadrants
            document.getElementById('quadrantSelector').style.display = 'flex';
        }

        function createChipHTML(chipNumber, ligne, col) {
            const chipData = universeData.chipDetails[chipNumber];
            const formesData = chipData ? chipData.formes_data : {};
            const formes = getUniverseFormes();
            
            // Déterminer le quadrant
            let quadrantClass = '';
            
            if (ligne <= 4 && col <= 3) {
                quadrantClass = 'quadrant-q1';
            }
            else if (ligne <= 4 && col >= 4) {
                quadrantClass = 'quadrant-q2';
            }
            else if (ligne >= 5 && col <= 3) {
                quadrantClass = 'quadrant-q3';
            }
            else if (ligne >= 5 && col >= 4) {
                quadrantClass = 'quadrant-q4';
            }
            
            let html = `
                <div class="chip-cell ${quadrantClass}" data-chip="${chipNumber}" onclick="showChipDetails(${chipNumber})" title="chip${chipNumber}" data-quadrant="${quadrantClass.replace('quadrant-', '')}">
                    <div class="chip-header">chip${chipNumber}</div>
                    <div class="chip-drawers">
            `;
            
            // Créer les tiroirs selon les formes disponibles
            formes.forEach(forme => {
                const formeItems = formesData[forme] || [];
                const isEmpty = formeItems.length === 0;
                const icon = FORME_ICONS[forme] || '?';
                
                // Gérer les dénominations multiples
                let displayText = '---';
                let allDenominations = [];
                
                console.log(`Chip ${chipNumber}, Forme ${forme}:`, formeItems);
                
                if (formeItems.length > 0) {
                    // Extraire toutes les dénominations uniques
                    allDenominations = [...new Set(formeItems.map(item => item.denomination))];
                    
                    if (allDenominations.length === 1) {
                        // Une seule dénomination
                        displayText = allDenominations[0];
                    } else if (allDenominations.length > 1) {
                        // Dénominations multiples - les joindre avec "/"
                        displayText = allDenominations.join('/');
                    }
                    
                    console.log(`Affichage: ${displayText}`);
                } else {
                    console.log(`Aucune donnée pour chip ${chipNumber}, forme ${forme}`);
                }
                
                // Stocker toutes les dénominations pour la recherche
                const searchDenominations = allDenominations.length > 0 ? allDenominations.join('/') : displayText;
                
                html += `
                    <div class="chip-drawer ${isEmpty ? 'empty' : ''}" 
                         data-forme="${forme}" data-chip="${chipNumber}"
                         data-denomination="${displayText}">
                        ${generateFormeIcon(forme)}
                        <span class="drawer-text ${isEmpty ? '' : 'clickable-denomination'}" 
                              onclick="${isEmpty ? '' : `showDenominationCombinations('${displayText}', '${currentUniverse}', event)`}">
                            ${displayText}
                        </span>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function organizeByForme(combinations) {
            const groups = {};
            
            combinations.forEach(combo => {
                const forme = combo.forme || 'unknown';
                if (!groups[forme]) {
                    groups[forme] = [];
                }
                
                // Extraire le nom de l'objet (ex: "road 1" -> "road 1")
                const objectName = combo.object_name || combo.denomination || 'item';
                groups[forme].push(objectName);
            });
            
            return groups;
        }

        function getUniverseFormes() {
            // Utiliser les formes récupérées depuis la DB
            if (universeData && universeData.formes && universeData.formes.formes) {
                return universeData.formes.formes;
            }
            
            // Formes par défaut si pas de données DB
            return ['carre', 'triangle', 'cercle', 'rectangle'];
        }

        function displayUniverseInfo() {
            const infoDiv = document.getElementById('universeInfo');
            const formes = getUniverseFormes();
            const totalChips = Object.keys(universeData.chipDetails).length;
            
            let activeChips = 0;
            Object.values(universeData.chipDetails).forEach(chip => {
                if (chip.combinations && chip.combinations.length > 0) {
                    activeChips++;
                }
            });
            
            infoDiv.innerHTML = `
                <h3>🌍 Univers: ${currentUniverse.toUpperCase()}</h3>
                <p><strong>Total Chips:</strong> ${totalChips}/48</p>
                <p><strong>Chips Actifs:</strong> ${activeChips}</p>
                <p><strong>Formes Disponibles:</strong> ${formes.length} (${formes.join(', ')})</p>
                <p><strong>Géométrie:</strong> ${formes.length > 4 ? 'Variable avec formes combinées' : 'Standard 4 formes'}</p>
            `;
            infoDiv.style.display = 'block';
        }

        function displayFormesLegend() {
            const legendDiv = document.getElementById('formesLegend');
            const formes = getUniverseFormes();
            
            let html = `
                <h4>🎨 Légende des Formes - ${currentUniverse.toUpperCase()}</h4>
                <div class="formes-grid">
            `;
            
            formes.forEach(forme => {
                html += `
                    <div class="forme-item" onclick="selectForme('${forme}')" data-forme="${forme}">
                        <div class="forme-legend-icon">
                            ${generateFormeLegendIcon(forme)}
                        </div>
                        <div class="forme-legend-text">${forme}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            legendDiv.innerHTML = html;
            legendDiv.style.display = 'block';
        }

        function selectForme(forme) {
            // Désélectionner la forme précédente
            document.querySelectorAll('.forme-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Sélectionner la nouvelle forme
            document.querySelector(`[data-forme="${forme}"]`).classList.add('selected');
            selectedForme = forme;
        }

        function highlightForme() {
            if (!selectedForme) {
                alert('Veuillez d\'abord sélectionner une forme dans la légende');
                return;
            }
            
            // Reset tous les tiroirs
            document.querySelectorAll('.chip-drawer').forEach(drawer => {
                drawer.style.background = '';
                drawer.style.transform = '';
                drawer.style.boxShadow = '';
            });
            
            // Surligner les tiroirs de la forme sélectionnée
            document.querySelectorAll(`[data-forme="${selectedForme}"]`).forEach(drawer => {
                if (!drawer.classList.contains('empty')) {
                    drawer.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                    drawer.style.transform = 'scale(1.1)';
                    drawer.style.boxShadow = '0 5px 15px rgba(39, 174, 96, 0.4)';
                    drawer.style.color = 'white';
                    drawer.style.fontWeight = 'bold';
                }
            });
            
            showSuccess(`Forme "${selectedForme}" surlignée! ${document.querySelectorAll(`[data-forme="${selectedForme}"]:not(.empty)`).length} tiroirs trouvés.`);
        }

        function resetHighlight() {
            // Reset tous les tiroirs
            document.querySelectorAll('.chip-drawer').forEach(drawer => {
                drawer.style.background = '';
                drawer.style.transform = '';
                drawer.style.boxShadow = '';
                drawer.style.color = '';
                drawer.style.fontWeight = '';
            });
            
            // Désélectionner la forme
            document.querySelectorAll('.forme-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            selectedForme = null;
            
            showSuccess('Surlignage réinitialisé');
        }

        function showChipDetails(chipNumber) {
            const chipData = universeData.chipDetails[chipNumber];
            if (!chipData || !chipData.formes_data || Object.keys(chipData.formes_data).length === 0) {
                alert(`chip${chipNumber}: Aucune donnée disponible`);
                return;
            }
            
            const formesData = chipData.formes_data;
            let details = `🎯 chip${chipNumber} - ${currentUniverse.toUpperCase()}\n\n`;
            
            // Organiser par forme
            Object.entries(formesData).forEach(([forme, items]) => {
                const icon = FORME_ICONS[forme] || '?';
                details += `${icon} ${forme.toUpperCase()}:\n`;
                items.slice(0, 3).forEach(item => {
                    details += `  • ${item.denomination}\n`;
                });
                if (items.length > 3) {
                    details += `  ... et ${items.length - 3} autres\n`;
                }
                details += '\n';
            });
            
            const totalItems = Object.values(formesData).reduce((sum, items) => sum + items.length, 0);
            details += `📊 Total: ${totalItems} éléments`;
            alert(details);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            // Insérer dans main-content au lieu de container
            const mainContent = document.querySelector('.main-content');
            const katulaContainer = document.getElementById('katulaContainer');
            
            if (mainContent && katulaContainer) {
                mainContent.insertBefore(errorDiv, katulaContainer);
            } else {
                // Fallback: ajouter à la fin du container
                document.querySelector('.container').appendChild(errorDiv);
            }
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            // Insérer dans main-content au lieu de container
            const mainContent = document.querySelector('.main-content');
            const katulaContainer = document.getElementById('katulaContainer');
            
            if (mainContent && katulaContainer) {
                mainContent.insertBefore(successDiv, katulaContainer);
            } else {
                // Fallback: ajouter à la fin du container
                document.querySelector('.container').appendChild(successDiv);
            }
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Variables globales pour la sélection des quadrants
        let selectedQuadrant = null;

        async function showDenominationCombinations(denomination, universe, event) {
            event.stopPropagation();
            
            if (denomination === '---') return;
            
            try {
                console.log(`Récupération combinaisons pour: ${denomination}`);
                
                const response = await fetch(`${API_BASE}/denomination/${universe}/${encodeURIComponent(denomination)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    displayCombinationsModal(data);
                } else {
                    alert(`Aucune combinaison trouvée pour "${denomination}"`);
                }
                
            } catch (error) {
                console.error('Erreur récupération combinaisons:', error);
                alert(`Erreur: ${error.message}`);
            }
        }
        
        function displayCombinationsModal(data) {
            const { denomination, universe, details } = data;
            
            const modalHTML = `
                <div id="combinationsModal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>🎯 ${denomination.toUpperCase()}</h2>
                            <span class="modal-close" onclick="closeCombinationsModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="modal-info">
                                <span class="info-badge universe">UNIVERS: ${universe.toUpperCase()}</span>
                                <span class="info-badge count">COMBINAISONS: ${details.length}</span>
                            </div>
                            <div class="combinations-grid">
                                ${generateCombinationsGrid(details)}
                            </div>
                            <div class="modal-actions">
                                <button onclick="closeCombinationsModal()" class="btn-close">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function generateCombinationsGrid(details) {
            if (details.length === 0) {
                return '<div class="no-combinations">Aucune combinaison trouvée</div>';
            }
            
            let html = '<div class="combinations-list">';
            
            details.forEach((detail, index) => {
                const positionClass = `position-${detail.alpha_ranking || 'na'}`;
                html += `
                    <div class="combination-item">
                        <div class="combination-numbers">${detail.num1}-${detail.num2}</div>
                        <div class="combination-position ${positionClass}">
                            Position: ${detail.alpha_ranking || 'n/a'}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        function closeCombinationsModal() {
            const modal = document.getElementById('combinationsModal');
            if (modal) {
                modal.remove();
            }
        }

        async function showDenominationDetails(denomination, universe, event) {
            // Empêcher la propagation pour éviter le clic sur le chip
            event.stopPropagation();
            
            if (denomination === '---') return;
            
            try {
                console.log(`Récupération des détails pour: ${denomination} dans ${universe}`);
                
                // Gérer les dénominations multiples séparées par "/"
                const denominations = denomination.split('/').map(d => d.trim());
                let allCombinations = [];
                
                for (const singleDenomination of denominations) {
                    console.log('Recherche:', singleDenomination);
                    
                    const url = `${API_BASE}/denomination/${universe}/${encodeURIComponent(singleDenomination)}`;
                    console.log('URL:', url);
                    
                    const response = await fetch(url);
                    console.log('Status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Données reçues:', data);
                        if (data.details && data.details.length > 0) {
                            allCombinations.push(...data.details);
                        }
                    } else {
                        const errorText = await response.text();
                        console.warn(`Aucune donnée pour "${singleDenomination}": ${response.status} - ${errorText}`);
                    }
                }
                
                if (allCombinations.length === 0) {
                    alert(`Aucune combinaison trouvée pour "${denomination}" dans ${universe}`);
                    return;
                }
                
                // Trier les combinaisons par dénomination puis par position alphabétique
                allCombinations.sort((a, b) => {
                    // D'abord par dénomination
                    if (a.denomination !== b.denomination) {
                        return a.denomination.localeCompare(b.denomination);
                    }
                    // Puis par position alphabétique (alpha_ranking)
                    const posA = a.alpha_ranking || 'z';
                    const posB = b.alpha_ranking || 'z';
                    return posA.localeCompare(posB);
                });
                
                // Créer la structure de données pour la modale
                const combinedData = {
                    denomination: denomination,
                    universe: universe,
                    total_occurrences: allCombinations.length,
                    details: allCombinations
                };
                
                displayDenominationModal(combinedData);
                
            } catch (error) {
                console.error('Erreur récupération dénomination:', error);
                alert(`Erreur lors de la récupération des détails de "${denomination}": ${error.message}`);
            }
        }

        function displayDenominationModal(data) {
            const { universe, denomination, total_occurrences, details } = data;
            
            // Vérifier si c'est une recherche multiple (avec "/")
            const isMultipleSearch = denomination.includes('/');
            
            // Créer une modale HTML interactive au lieu d'un simple alert
            const modalHTML = `
                <div id="denominationModal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>${denomination}</h2>
                            <span class="modal-close" onclick="closeDenominationModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="modal-info">
                                <span class="info-badge universe">UNIVERS: ${universe.toUpperCase()}</span>
                                <span class="info-badge count">OCCURRENCES: ${total_occurrences}</span>
                            </div>
                            <div class="combinations-container">
                                ${generateCombinationsHTML(details, isMultipleSearch)}
                            </div>
                            <div class="modal-actions">
                                <button onclick="showAllCombinations()" class="btn-show-all">Afficher Tout</button>
                                <button onclick="exportCombinations()" class="btn-export">Exporter</button>
                                <button onclick="closeDenominationModal()" class="btn-close">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ajouter la modale au DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Stocker les données pour utilisation ultérieure
            window.currentDenominationData = data;
        }
        
        function generateCombinationsHTML(details, isMultipleSearch) {
            const maxInitialDisplay = 20; // Limiter l'affichage initial
            let html = '';
            
            if (isMultipleSearch) {
                // Grouper par dénomination individuelle
                const groupedByDenom = {};
                details.forEach(detail => {
                    if (!groupedByDenom[detail.denomination]) {
                        groupedByDenom[detail.denomination] = [];
                    }
                    groupedByDenom[detail.denomination].push(detail);
                });
                
                // Afficher chaque groupe avec limitation
                Object.entries(groupedByDenom).forEach(([denom, combinations]) => {
                    html += `<div class="denomination-group">
                        <h4>${denom.toUpperCase()} (${combinations.length} combinaisons)</h4>
                        <div class="combinations-list">`;
                    
                    const displayCount = Math.min(combinations.length, maxInitialDisplay);
                    
                    combinations.slice(0, displayCount).forEach((detail, index) => {
                        html += `
                            <div class="combination-item">
                                <span class="combination-number">${detail.num1}-${detail.num2}</span>
                                <span class="combination-position position-${detail.alpha_ranking || 'na'}">${detail.alpha_ranking || 'N/A'}</span>
                            </div>`;
                    });
                    
                    if (combinations.length > maxInitialDisplay) {
                        html += `<div class="show-more" onclick="showMoreCombinations('${denom}')">
                            ... et ${combinations.length - maxInitialDisplay} autres combinaisons (cliquer pour voir)
                        </div>`;
                    }
                    
                    html += `</div></div>`;
                });
            } else {
                // Affichage pour une seule dénomination
                html += `<div class="combinations-list">`;
                
                const displayCount = Math.min(details.length, maxInitialDisplay);
                
                details.slice(0, displayCount).forEach((detail, index) => {
                    html += `
                        <div class="combination-item">
                            <span class="combination-number">${detail.num1}-${detail.num2}</span>
                            <span class="combination-position position-${detail.alpha_ranking || 'na'}">${detail.alpha_ranking || 'N/A'}</span>
                        </div>`;
                });
                
                if (details.length > maxInitialDisplay) {
                    html += `<div class="show-more" onclick="showAllCombinations()">
                        ... et ${details.length - maxInitialDisplay} autres combinaisons (cliquer pour voir toutes)
                    </div>`;
                }
                
                html += `</div>`;
            }
            
            return html;
        }
        
        function closeDenominationModal() {
            const modal = document.getElementById('denominationModal');
            if (modal) {
                modal.remove();
            }
            window.currentDenominationData = null;
        }
        
        function showAllCombinations() {
            if (!window.currentDenominationData) return;
            
            const data = window.currentDenominationData;
            const container = document.querySelector('.combinations-container');
            
            // Régénérer avec toutes les combinaisons
            container.innerHTML = generateAllCombinationsHTML(data.details, data.denomination.includes('/'));
        }
        
        function generateAllCombinationsHTML(details, isMultipleSearch) {
            let html = '';
            
            if (isMultipleSearch) {
                const groupedByDenom = {};
                details.forEach(detail => {
                    if (!groupedByDenom[detail.denomination]) {
                        groupedByDenom[detail.denomination] = [];
                    }
                    groupedByDenom[detail.denomination].push(detail);
                });
                
                Object.entries(groupedByDenom).forEach(([denom, combinations]) => {
                    html += `<div class="denomination-group">
                        <h4>${denom.toUpperCase()} (${combinations.length} combinaisons)</h4>
                        <div class="combinations-list">`;
                    
                    combinations.forEach((detail, index) => {
                        html += `
                            <div class="combination-item">
                                <span class="combination-number">${detail.num1}-${detail.num2}</span>
                                <span class="combination-position">Position: ${detail.alpha_ranking || 'N/A'}</span>
                            </div>`;
                    });
                    
                    html += `</div></div>`;
                });
            } else {
                html += `<div class="combinations-list">`;
                
                details.forEach((detail, index) => {
                    html += `
                        <div class="combination-item">
                            <span class="combination-number">${detail.num1}-${detail.num2}</span>
                            <span class="combination-position">Position: ${detail.alpha_ranking || 'N/A'}</span>
                        </div>`;
                });
                
                html += `</div>`;
            }
            
            return html;
        }
        
        function exportCombinations() {
            if (!window.currentDenominationData) return;
            
            const data = window.currentDenominationData;
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Denomination,Combination,Position,Univers\n" +
                data.details.map(d => 
                    `${d.denomination},${d.num1}-${d.num2},${d.alpha_ranking || 'N/A'},${d.univers}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${data.denomination.replace('/', '_')}_${data.universe}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function selectQuadrant(quadrant) {
            // Désélectionner le quadrant précédent
            clearQuadrantSelection();
            
            // Sélectionner le nouveau quadrant
            selectedQuadrant = quadrant;
            
            // Mettre à jour l'interface
            document.querySelectorAll('.quadrant-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.quadrant-btn.${quadrant}`).classList.add('active');
            
            // Surligner les chips du quadrant sélectionné
            document.querySelectorAll(`.chip-cell.quadrant-${quadrant}`).forEach(chip => {
                chip.classList.add('selected-quadrant');
            });
            
            // Afficher les statistiques du quadrant
            showQuadrantStats(quadrant);
        }

        function clearQuadrantSelection() {
            selectedQuadrant = null;
            
            // Retirer toutes les sélections
            document.querySelectorAll('.quadrant-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.chip-cell').forEach(chip => {
                chip.classList.remove('selected-quadrant');
            });
            
            // Cacher les statistiques
            hideQuadrantStats();
        }

        function showQuadrantStats(quadrant) {
            const chips = document.querySelectorAll(`.chip-cell.quadrant-${quadrant}`);
            const chipNumbers = Array.from(chips).map(chip => {
                const title = chip.getAttribute('title');
                return parseInt(title.replace('chip', ''));
            });
            
            const stats = {
                quadrant: quadrant,
                total_chips: chips.length,
                chip_numbers: chipNumbers.sort((a, b) => a - b),
                universe: currentUniverse
            };
            
            console.log(`Quadrant ${quadrant} sélectionné:`, stats);
            showSuccess(`Quadrant ${quadrant} sélectionné: ${stats.total_chips} chips (chip${chipNumbers.slice(0, 6).join(', chip')}...)`);
        }

        function hideQuadrantStats() {
            // Cacher les statistiques si nécessaire
        }

        // Auto-charger Mundo au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('universeSelect').value = 'mundo';
            setTimeout(() => loadUniverse(), 1000);
        });
    </script>
</body>
</html>