<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EazzyCalculator - R√©seaux LSTM</title>
    <script src="assets/js/universal-header.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .header {
            text-align: center;
            color: #1890ff;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #1890ff, #722ed1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .navigation-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .nav-button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .nav-button:hover {
            background: #40a9ff;
            color: white;
        }

        .nav-button.active {
            background: #722ed1;
        }

        .controls {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        select, button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        button {
            background: linear-gradient(135deg, #1890ff, #40a9ff);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 1px solid #e8e8e8;
        }

        .section-title {
            background: linear-gradient(135deg, #1890ff, #722ed1);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: -20px -20px 20px -20px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }

        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .model-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .model-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .model-card.trained {
            border-left: 4px solid #52c41a;
            background: #f6ffed;
        }

        .model-card.not-trained {
            border-left: 4px solid #ff4d4f;
            background: #fff2f0;
        }

        .model-card h3 {
            margin: 0 0 15px 0;
            color: #1890ff;
            font-size: 18px;
        }

        .model-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-trained {
            background: #52c41a;
        }

        .status-not-trained {
            background: #ff4d4f;
        }

        .model-metrics {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #666;
            font-size: 14px;
        }

        .metric-value {
            font-weight: bold;
            color: #1890ff;
        }

        .predictions-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .prediction-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .prediction-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .prediction-card.high-confidence {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .prediction-card.medium-confidence {
            background: linear-gradient(135deg, #ffa726, #ff9800);
        }

        .prediction-card.low-confidence {
            background: linear-gradient(135deg, #66bb6a, #4caf50);
        }

        .prediction-card h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            opacity: 0.9;
        }

        .prediction-card .value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .prediction-card .confidence {
            font-size: 18px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .prediction-card .model-type {
            font-size: 12px;
            opacity: 0.8;
        }

        .training-progress {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #1890ff, #40a9ff);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .log-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <!-- Header Universel -->
    <div id="header-container"></div>
    
    <div class="container" style="margin-top: 100px;">
        <div class="header">
            <h1>üß† R√©seaux de Neurones LSTM</h1>
            <p>Intelligence Artificielle Avanc√©e pour Pr√©dictions Ultra-Pr√©cises</p>
        </div>

        <!-- Barre de navigation -->
        <div class="navigation-bar">
            <h4 style="margin: 0 0 10px 0; color: #1890ff;">üß≠ Navigation IA</h4>
            <a href="test-interface.html" class="nav-button">üé≤ Interface Simple</a>
            <a href="smart-input.html" class="nav-button">üîÑ Sessions Cycliques</a>
            <a href="advanced-journal.html" class="nav-button">üìã Journal Avanc√©</a>
            <a href="gap-analysis.html" class="nav-button">üìä Analyse √âcarts</a>
            <a href="pattern-viewer.html" class="nav-button">üîç Patterns</a>
            <a href="prediction-panel.html" class="nav-button">ü§ñ Pr√©dictions ML</a>
            <a href="lstm-neural-network.html" class="nav-button active">üß† R√©seaux LSTM</a>
        </div>

        <!-- Contr√¥les -->
        <div class="controls">
            <label for="universeSelect">Univers:</label>
            <select id="universeSelect">
                <option value="mundo" selected>Mundo</option>
                <option value="fruity">Fruity</option>
                <option value="trigga">Trigga</option>
                <option value="roaster">Roaster</option>
                <option value="sunshine">Sunshine</option>
            </select>

            <label for="epochsSelect">√âpoques d'entra√Ænement:</label>
            <select id="epochsSelect">
                <option value="25">25 (Rapide)</option>
                <option value="50" selected>50 (Recommand√©)</option>
                <option value="100">100 (Pr√©cis)</option>
                <option value="200">200 (Ultra-pr√©cis)</option>
            </select>

            <button onclick="checkModelStatus()" id="statusBtn">üìä V√©rifier Statut</button>
            <button onclick="trainAllModels()" id="trainBtn">üöÄ Entra√Æner Tous</button>
            <button onclick="generatePredictions()" id="predictBtn">üîÆ Pr√©dictions LSTM</button>
            <button onclick="evaluateModels()" id="evalBtn">üìà √âvaluer Mod√®les</button>
        </div>

        <!-- Statut des mod√®les -->
        <div class="status-section">
            <h2 class="section-title">üìä Statut des Mod√®les LSTM</h2>
            <div id="modelStatusContainer" class="model-grid"></div>
        </div>

        <!-- Pr√©dictions LSTM -->
        <div class="predictions-section">
            <h2 class="section-title">üîÆ Pr√©dictions des R√©seaux de Neurones</h2>
            <div id="predictionsContainer" class="prediction-cards"></div>
        </div>

        <!-- Progression d'entra√Ænement -->
        <div class="training-progress" id="trainingProgress">
            <h3>üöÄ Entra√Ænement en cours...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div id="trainingStatus">Initialisation...</div>
            <div class="log-output" id="logOutput"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/analytics';
        let currentUniverse = 'mundo';

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            // Injecter le header universel
            if (typeof UniversalHeader !== 'undefined') {
                UniversalHeader.injectHeader('header-container', 'prediction', {
                    showNavigation: true,
                    showUserInfo: true
                });
            }
            
            console.log('üß† Initialisation des r√©seaux LSTM...');
            checkModelStatus();
        });

        async function checkModelStatus() {
            const statusBtn = document.getElementById('statusBtn');
            const universe = document.getElementById('universeSelect').value;
            currentUniverse = universe;

            statusBtn.disabled = true;
            statusBtn.textContent = 'üîÑ V√©rification...';

            try {
                const response = await fetch(`${API_BASE}/ml/status/${universe}`);
                const data = await response.json();

                if (response.ok) {
                    displayModelStatus(data);
                } else {
                    showError('Erreur lors de la v√©rification du statut: ' + data.detail);
                }

            } catch (error) {
                showError('Erreur de connexion: ' + error.message);
            } finally {
                statusBtn.disabled = false;
                statusBtn.textContent = 'üìä V√©rifier Statut';
            }
        }

        function displayModelStatus(statusData) {
            const container = document.getElementById('modelStatusContainer');
            
            let html = '';
            
            for (const [attribute, status] of Object.entries(statusData.model_details)) {
                const cardClass = status.ready_for_prediction ? 'trained' : 'not-trained';
                const statusClass = status.ready_for_prediction ? 'status-trained' : 'status-not-trained';
                const statusText = status.ready_for_prediction ? 'Entra√Æn√©' : 'Non entra√Æn√©';
                
                html += `
                    <div class="model-card ${cardClass}">
                        <h3>${attribute.toUpperCase()}</h3>
                        <div class="model-status">
                            <div class="status-indicator ${statusClass}"></div>
                            <span>${statusText}</span>
                        </div>
                        <div class="model-metrics">
                            <div class="metric-item">
                                <span class="metric-label">Mod√®le:</span>
                                <span class="metric-value">${status.model_exists ? 'Disponible' : 'Manquant'}</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Pr√™t pour pr√©diction:</span>
                                <span class="metric-value">${status.ready_for_prediction ? 'Oui' : 'Non'}</span>
                            </div>
                            ${status.error ? `<div class="error">Erreur: ${status.error}</div>` : ''}
                        </div>
                        ${!status.ready_for_prediction ? 
                            `<button onclick="trainSingleModel('${attribute}')" style="margin-top: 10px; width: 100%;">
                                üöÄ Entra√Æner ${attribute}
                            </button>` : ''}
                    </div>
                `;
            }
            
            // Ajouter le r√©sum√©
            html += `
                <div class="model-card" style="border-left: 4px solid #1890ff; background: #f0f9ff;">
                    <h3>üìä R√âSUM√â GLOBAL</h3>
                    <div class="model-metrics">
                        <div class="metric-item">
                            <span class="metric-label">Mod√®les pr√™ts:</span>
                            <span class="metric-value">${statusData.ready_models}/${statusData.total_models}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">√Ä entra√Æner:</span>
                            <span class="metric-value">${statusData.models_to_train}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Univers:</span>
                            <span class="metric-value">${statusData.universe}</span>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function trainAllModels() {
            const trainBtn = document.getElementById('trainBtn');
            const universe = document.getElementById('universeSelect').value;
            const epochs = parseInt(document.getElementById('epochsSelect').value);

            trainBtn.disabled = true;
            trainBtn.textContent = 'üöÄ Entra√Ænement...';
            
            showTrainingProgress();

            try {
                const response = await fetch(`${API_BASE}/ml/train/${universe}?epochs=${epochs}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    displayTrainingResults(data);
                    showSuccess(`Entra√Ænement termin√©! ${data.successful_trainings}/${data.total_models} mod√®les r√©ussis`);
                    
                    // Actualiser le statut
                    setTimeout(() => checkModelStatus(), 1000);
                } else {
                    showError('Erreur lors de l\'entra√Ænement: ' + data.detail);
                }

            } catch (error) {
                showError('Erreur de connexion: ' + error.message);
            } finally {
                trainBtn.disabled = false;
                trainBtn.textContent = 'üöÄ Entra√Æner Tous';
                hideTrainingProgress();
            }
        }

        async function trainSingleModel(attribute) {
            const universe = document.getElementById('universeSelect').value;
            const epochs = parseInt(document.getElementById('epochsSelect').value);

            try {
                const response = await fetch(`${API_BASE}/ml/train-single/${universe}/${attribute}?epochs=${epochs}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    showSuccess(`Mod√®le ${attribute} entra√Æn√© avec succ√®s! Pr√©cision: ${(data.final_accuracy * 100).toFixed(1)}%`);
                    checkModelStatus();
                } else {
                    showError(`Erreur lors de l'entra√Ænement de ${attribute}: ` + data.detail);
                }

            } catch (error) {
                showError('Erreur: ' + error.message);
            }
        }

        async function generatePredictions() {
            const predictBtn = document.getElementById('predictBtn');
            const universe = document.getElementById('universeSelect').value;

            predictBtn.disabled = true;
            predictBtn.textContent = 'üîÆ G√©n√©ration...';

            try {
                const response = await fetch(`${API_BASE}/ml/predict/${universe}`);
                const data = await response.json();

                if (response.ok) {
                    displayPredictions(data);
                } else {
                    showError('Erreur lors des pr√©dictions: ' + data.detail);
                }

            } catch (error) {
                showError('Erreur de connexion: ' + error.message);
            } finally {
                predictBtn.disabled = false;
                predictBtn.textContent = 'üîÆ Pr√©dictions LSTM';
            }
        }

        function displayPredictions(predictionData) {
            const container = document.getElementById('predictionsContainer');
            
            let html = '';
            
            if (predictionData.top_predictions && predictionData.top_predictions.length > 0) {
                predictionData.top_predictions.forEach((pred, index) => {
                    const confidence = pred.confidence_percent;
                    let cardClass = 'low-confidence';
                    
                    if (confidence > 80) cardClass = 'high-confidence';
                    else if (confidence > 60) cardClass = 'medium-confidence';
                    
                    html += `
                        <div class="prediction-card ${cardClass}">
                            <h4>#${index + 1} - ${pred.attribute_type.toUpperCase()}</h4>
                            <div class="value">${pred.predicted_value}</div>
                            <div class="confidence">${confidence}%</div>
                            <div class="model-type">R√©seau LSTM</div>
                        </div>
                    `;
                });
            } else {
                html = '<p>Aucune pr√©diction disponible. Entra√Ænez d\'abord les mod√®les.</p>';
            }
            
            // Ajouter le r√©sum√©
            html += `
                <div class="prediction-card" style="background: linear-gradient(135deg, #1890ff, #722ed1);">
                    <h4>üìä R√âSUM√â LSTM</h4>
                    <div class="value">${predictionData.successful_predictions}/${predictionData.total_predictions}</div>
                    <div class="confidence">Mod√®les actifs</div>
                    <div class="model-type">Intelligence Artificielle</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function evaluateModels() {
            const evalBtn = document.getElementById('evalBtn');
            const universe = document.getElementById('universeSelect').value;

            evalBtn.disabled = true;
            evalBtn.textContent = 'üìà √âvaluation...';

            try {
                const response = await fetch(`${API_BASE}/ml/evaluate/${universe}`);
                const data = await response.json();

                if (response.ok) {
                    showSuccess(`√âvaluation termin√©e! Pr√©cision moyenne: ${(data.average_accuracy * 100).toFixed(1)}%`);
                    displayEvaluationResults(data);
                    console.log('R√©sultats d\'√©valuation:', data);
                } else {
                    showError('Erreur lors de l\'√©valuation: ' + data.detail);
                }

            } catch (error) {
                showError('Erreur de connexion: ' + error.message);
            } finally {
                evalBtn.disabled = false;
                evalBtn.textContent = 'üìà √âvaluer Mod√®les';
            }
        }

        function displayEvaluationResults(evaluationData) {
            const container = document.getElementById('predictionsContainer');
            
            let html = '<h3 style="text-align: center; color: #1890ff; margin-bottom: 20px;">üìà R√©sultats d\'√âvaluation des Mod√®les</h3>';
            
            // M√©triques globales
            html += `
                <div class="prediction-card" style="background: linear-gradient(135deg, #52c41a, #73d13d);">
                    <h4>üìä M√âTRIQUES GLOBALES</h4>
                    <div class="value">${(evaluationData.average_accuracy * 100).toFixed(1)}%</div>
                    <div class="confidence">Pr√©cision Moyenne</div>
                    <div class="model-type">Perte: ${evaluationData.average_loss.toFixed(3)}</div>
                </div>
            `;
            
            // D√©tails par mod√®le
            if (evaluationData.model_evaluations) {
                for (const [attribute, evaluation] of Object.entries(evaluationData.model_evaluations)) {
                    if (!evaluation.error) {
                        const accuracy = (evaluation.test_accuracy * 100).toFixed(1);
                        let cardClass = 'low-confidence';
                        
                        if (accuracy > 85) cardClass = 'high-confidence';
                        else if (accuracy > 70) cardClass = 'medium-confidence';
                        
                        html += `
                            <div class="prediction-card ${cardClass}">
                                <h4>${attribute.toUpperCase()}</h4>
                                <div class="value">${accuracy}%</div>
                                <div class="confidence">Pr√©cision</div>
                                <div class="model-type">Perte: ${evaluation.test_loss.toFixed(3)}</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="prediction-card" style="background: linear-gradient(135deg, #ff4d4f, #ff7875);">
                                <h4>${attribute.toUpperCase()}</h4>
                                <div class="value">‚ùå</div>
                                <div class="confidence">Erreur</div>
                                <div class="model-type">${evaluation.error}</div>
                            </div>
                        `;
                    }
                }
            }
            
            // R√©sum√©
            html += `
                <div class="prediction-card" style="background: linear-gradient(135deg, #1890ff, #722ed1);">
                    <h4>üìà R√âSUM√â √âVALUATION</h4>
                    <div class="value">${evaluationData.evaluated_models}/${evaluationData.total_models}</div>
                    <div class="confidence">Mod√®les √âvalu√©s</div>
                    <div class="model-type">Analyse Compl√®te</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function showTrainingProgress() {
            document.getElementById('trainingProgress').style.display = 'block';
            // Simulation de progression
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 95) progress = 95;
                
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('trainingStatus').textContent = `Progression: ${progress.toFixed(0)}%`;
                
                if (progress >= 95) {
                    clearInterval(interval);
                }
            }, 1000);
        }

        function hideTrainingProgress() {
            document.getElementById('trainingProgress').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
        }

        function displayTrainingResults(results) {
            console.log('R√©sultats d\'entra√Ænement:', results);
            
            let logHtml = '';
            for (const [attribute, result] of Object.entries(results.training_results)) {
                if (result.error) {
                    logHtml += `‚ùå ${attribute}: ${result.error}\n`;
                } else {
                    logHtml += `‚úÖ ${attribute}: Pr√©cision ${(result.final_accuracy * 100).toFixed(1)}%\n`;
                }
            }
            
            document.getElementById('logOutput').textContent = logHtml;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.status-section'));
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.status-section'));
            
            setTimeout(() => successDiv.remove(), 5000);
        }
    </script>
</body>

</html>